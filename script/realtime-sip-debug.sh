#!/bin/bash

# üîç –ê–ù–ê–õ–ò–ó SIP –¢–†–ê–§–ò–ö–ê –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
# –î–µ—Ç–∞–ª—å–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ SIP —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

CONTAINER_NAME="freeswitch-test"

echo "üîç –†–ï–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó SIP –¢–†–ê–§–ò–ö–ê"
echo "============================="
echo ""

echo "üö® –ü—Ä–æ–±–ª–µ–º–∞: FailedCallsOUT 3/3 - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –í–°–ï –∑–≤–æ–Ω–∫–∏"
echo "üìã –¶–µ–ª—å: –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ SIP —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
echo ""

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
echo "‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ê –î–ï–¢–ê–õ–¨–ù–û–ì–û –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø"
echo "=================================="

docker exec "$CONTAINER_NAME" fs_cli -x "sofia profile internal siptrace on"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia loglevel all 9"
docker exec "$CONTAINER_NAME" fs_cli -x "console loglevel debug"

# –û—á–∏—â–∞–µ–º –ª–æ–≥–∏
docker exec "$CONTAINER_NAME" fs_cli -x "console clear"

echo "‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤ –≤ —Ñ–æ–Ω–µ
echo "üì° –ó–ê–ü–£–°–ö –ú–û–ù–ò–¢–û–†–ò–ù–ì–ê SIP –¢–†–ê–§–ò–ö–ê"
echo "==============================="

echo ""
echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ —Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º..."
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –∑–≤–æ–Ω–æ–∫
echo "üìû –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–≤–æ–Ω–æ–∫..."
CALL_UUID=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/79206054020 &echo" | grep -o '+OK [a-f0-9-]*' | cut -d' ' -f2)
echo "UUID –∑–≤–æ–Ω–∫–∞: $CALL_UUID"

echo ""
echo "‚è±Ô∏è –û–∂–∏–¥–∞–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è SIP –æ–±–º–µ–Ω–∞..."
sleep 3

echo ""
echo "üìã –ê–ù–ê–õ–ò–ó SIP –°–û–û–ë–©–ï–ù–ò–ô"
echo "======================"

# –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –ª–æ–≥–∏
echo ""
echo "1. üì§ –ò–°–•–û–î–Ø–©–ò–ï SIP –°–û–û–ë–©–ï–ù–ò–Ø (INVITE):"
echo "-------------------------------------"
OUTGOING=$(docker exec "$CONTAINER_NAME" fs_cli -x "console last 100" | grep -A10 -B2 "send.*INVITE")
if [ -n "$OUTGOING" ]; then
    echo "$OUTGOING"
else
    echo "‚ùå –ò—Å—Ö–æ–¥—è—â–∏–µ INVITE –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö –∫–æ–Ω—Å–æ–ª–∏"
fi

echo ""
echo "2. üì• –í–•–û–î–Ø–©–ò–ï SIP –û–¢–í–ï–¢–´:"
echo "------------------------"
INCOMING=$(docker exec "$CONTAINER_NAME" fs_cli -x "console last 100" | grep -A5 -B2 "recv.*SIP\|recv.*[0-9][0-9][0-9]")
if [ -n "$INCOMING" ]; then
    echo "$INCOMING"
else
    echo "‚ùå –í—Ö–æ–¥—è—â–∏–µ SIP –æ—Ç–≤–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–æ–≥–∞—Ö –∫–æ–Ω—Å–æ–ª–∏"
fi

echo ""
echo "3. üîç –ü–û–ò–°–ö –ö–û–î–û–í –û–®–ò–ë–û–ö:"
echo "-----------------------"
ERROR_CODES=$(docker exec "$CONTAINER_NAME" fs_cli -x "console last 50" | grep -E "[4-6][0-9][0-9].*")
if [ -n "$ERROR_CODES" ]; then
    echo "$ERROR_CODES"
else
    echo "‚ùå –ö–æ–¥—ã –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –ª–æ–≥–∞—Ö"
fi

echo ""
echo "4. üìÑ –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í–´–• –õ–û–ì–û–í:"
echo "-----------------------------"

# –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∏–∑ —Ñ–∞–π–ª–∞
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ FreeSWITCH..."
FILE_LOGS=$(docker exec "$CONTAINER_NAME" tail -50 /usr/local/freeswitch/log/freeswitch.log 2>/dev/null | grep -E "(INVITE|[4-6][0-9][0-9])" || echo "–§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
if [ "$FILE_LOGS" != "–§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã" ]; then
    echo "$FILE_LOGS"
else
    echo "‚ùå –§–∞–π–ª–æ–≤—ã–µ –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –ø—É—Å—Ç—ã"
fi

echo ""
echo "5. üîç –ê–ù–ê–õ–ò–ó DOCKER –õ–û–ì–û–í:"
echo "-------------------------"
echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ Docker –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
DOCKER_LOGS=$(docker logs --tail 20 "$CONTAINER_NAME" 2>&1 | grep -E "(INVITE|SIP|[4-6][0-9][0-9])" || echo "–ù–µ—Ç SIP –¥–∞–Ω–Ω—ã—Ö –≤ Docker –ª–æ–≥–∞—Ö")
echo "$DOCKER_LOGS"

echo ""
echo "6. üìä –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° GATEWAY:"
echo "---------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway internal::sip_trunk" | head -5

echo ""
echo "7. üß™ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ï–°–¢–´:"
echo "=========================="

# –¢–µ—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –Ω–æ–º–µ—Ä–æ–≤
echo ""
echo "–¢–µ—Å—Ç A: –ù–æ–º–µ—Ä —Å +7"
RESULT_A=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/+79206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $RESULT_A"
sleep 2

echo ""
echo "–¢–µ—Å—Ç B: –ù–æ–º–µ—Ä —Å 8" 
RESULT_B=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/89206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $RESULT_B"
sleep 2

# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
echo ""
echo "üìä –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:"
echo "======================="
FINAL_STATS=$(docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway internal::sip_trunk" | grep -E "(CallsOUT|FailedCallsOUT)")
echo "$FINAL_STATS"

echo ""
echo "üí° –î–ò–ê–ì–ù–û–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:"
echo "=========================="

# –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
TOTAL_CALLS=$(echo "$FINAL_STATS" | grep "CallsOUT" | head -1 | awk '{print $2}')
FAILED_CALLS=$(echo "$FINAL_STATS" | grep "FailedCallsOUT" | awk '{print $2}')

if [ "$FAILED_CALLS" = "$TOTAL_CALLS" ] && [ "$TOTAL_CALLS" -gt 0 ]; then
    echo ""
    echo "üö® –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê –ü–†–û–ë–õ–ï–ú–ê:"
    echo "- –í—Å–µ –∑–≤–æ–Ω–∫–∏ ($TOTAL_CALLS/$FAILED_CALLS) –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å"
    echo "- FreeSWITCH —Å–æ–∑–¥–∞–µ—Ç UUID (+OK) –Ω–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç"
    echo ""
    echo "üîç –ù–ê–ò–ë–û–õ–ï–ï –í–ï–†–û–Ø–¢–ù–´–ï –ü–†–ò–ß–ò–ù–´:"
    echo ""
    echo "1. üîê IP –ù–ï –ê–í–¢–û–†–ò–ó–û–í–ê–ù (90% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)"
    echo "   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: IP 46.173.16.147 –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
    echo ""
    echo "2. üìû –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –ù–û–ú–ï–†–ê (5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)"
    echo "   ‚úÖ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å: —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–æ–≤ (+7, 8, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞)"
    echo ""
    echo "3. üí∞ –ü–†–û–ë–õ–ï–ú–´ –° –ë–ê–õ–ê–ù–°–û–ú (5% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å)"
    echo "   ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: –±–∞–ª–∞–Ω—Å –∏ –ª–∏–º–∏—Ç—ã —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
fi

echo ""
echo "üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:"
echo "==============="
echo ""
echo "1. –ù–ï–ú–ï–î–õ–ï–ù–ù–û —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º –∏ —Å–æ–æ–±—â–∏—Ç–µ:"
echo "   - –í–∞—à IP —Å–µ—Ä–≤–µ—Ä–∞: 46.173.16.147"
echo "   - –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –¥–ª—è IP-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
echo "   - –£—Ç–æ—á–Ω–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤"
echo ""
echo "2. –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫:"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–ª–∞–Ω—Å"
echo "   - –£—Ç–æ—á–Ω–∏—Ç–µ –ª–∏–º–∏—Ç—ã –Ω–∞ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏"
echo "   - –ó–∞–ø—Ä–æ—Å–∏—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö SIP-—Å–æ–æ–±—â–µ–Ω–∏–π"
echo ""
echo "3. –ü–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ - —Å–æ–æ–±—â–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç,"
echo "   –∏ –º—ã –Ω–∞—Å—Ç—Ä–æ–∏–º FreeSWITCH –ø–æ–¥ –∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è"

echo ""
echo "‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!" 