#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ audio
# –ü—Ä–æ–±–ª–µ–º–∞: EACCES permission denied –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–æ–≤
# –ê–≤—Ç–æ—Ä: AI Assistant

echo "==============================================="
echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê –î–õ–Ø –ê–£–î–ò–û–§–ê–ô–õ–û–í"
echo "==============================================="

echo ""
echo "üîç 1. –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ò–• –ü–†–ê–í:"
echo "-----------------------------------------------"
if docker ps -q -f name="dialer_backend" | grep -q .; then
    echo "üìÇ –¢–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞ –ø–∞–ø–∫–∏ audio:"
    docker exec dialer_backend ls -la /app/audio
    
    echo ""
    echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Node.js –ø—Ä–æ—Ü–µ—Å—Å–∞:"
    docker exec dialer_backend whoami
    docker exec dialer_backend id
    
else
    echo "‚ùå Backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    exit 1
fi

echo ""
echo "üîß 2. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê:"
echo "-----------------------------------------------"

# –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
echo "üìù –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ –Ω–∞ nodeuser..."
docker exec dialer_backend chown -R nodeuser:nodejs /app/audio

echo "üìù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏..."
docker exec dialer_backend chmod -R 755 /app/audio

echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç..."
docker exec dialer_backend mkdir -p /app/audio

echo ""
echo "‚úÖ 3. –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "-----------------------------------------------"
echo "üìÇ –ü—Ä–∞–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
docker exec dialer_backend ls -la /app/audio

echo ""
echo "üß™ 4. –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "-----------------------------------------------"

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
TEST_FILE="/tmp/test_permissions.mp3"
echo -e "\xFF\xFB\x90\x00test audio content" > "$TEST_FILE"
echo "üìÅ –°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª: $(ls -la $TEST_FILE)"

# –ü–æ–ª—É—á–∞–µ–º ID –∫–∞–º–ø–∞–Ω–∏–∏
CAMPAIGNS_RESPONSE=$(curl -s "http://localhost:3000/api/campaigns")
CAMPAIGN_ID=$(echo "$CAMPAIGNS_RESPONSE" | grep -o '"id":[0-9]*' | head -1 | cut -d':' -f2)

if [ ! -z "$CAMPAIGN_ID" ]; then
    echo ""
    echo "üöÄ –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∫–∞–º–ø–∞–Ω–∏–∏ $CAMPAIGN_ID:"
    
    UPLOAD_RESULT=$(curl -s -X POST \
        -F "audio=@$TEST_FILE" \
        -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}s" \
        "http://localhost:3000/api/campaigns/$CAMPAIGN_ID/audio")
    
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏:"
    echo "$UPLOAD_RESULT"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª –≤ –ø–∞–ø–∫–µ
    echo ""
    echo "üìÅ –§–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ audio –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏:"
    docker exec dialer_backend ls -la /app/audio
    
    # –û—á–∏—Å—Ç–∫–∞
    rm -f "$TEST_FILE"
    
    # –ê–Ω–∞–ª–∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    if echo "$UPLOAD_RESULT" | grep -q "HTTP_CODE:200"; then
        echo ""
        echo "‚úÖ –£–°–ü–ï–•! –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ"
        echo "üéâ –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ —Ä–µ—à–µ–Ω–∞"
    else
        echo ""
        echo "‚ùå –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—à–∏–±–∫—É:"
        echo "$UPLOAD_RESULT" | grep -E "(error|Error)"
    fi
    
else
    echo "‚ùå –ö–∞–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
fi

echo ""
echo "üîç 5. –õ–û–ì–ò –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø:"
echo "-----------------------------------------------"
echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend:"
docker logs --tail 10 dialer_backend | grep -E "(audio|upload|error)" || echo "–õ–æ–≥–∏ —á–∏—Å—Ç—ã"

echo ""
echo "==============================================="
echo "üìã –ò–¢–û–ì–û–í–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø"
echo "==============================================="

echo ""
echo "üìù –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
echo "  ‚úÖ –ò–∑–º–µ–Ω–µ–Ω –≤–ª–∞–¥–µ–ª–µ—Ü –ø–∞–ø–∫–∏ /app/audio –Ω–∞ nodeuser:nodejs"
echo "  ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ 755 (—á—Ç–µ–Ω–∏–µ/–∑–∞–ø–∏—Å—å –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)"
echo "  ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–æ–≤"

echo ""
echo "üîç –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–µ—Ç—Å—è:"
echo "  1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: docker logs -f dialer_backend"
echo "  2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞: docker exec dialer_backend ls -la /app/audio"
echo "  3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: docker-compose restart backend"

echo ""
echo "üöÄ –î–∞–ª—å–Ω–µ–π—à–∏–µ –¥–µ–π—Å—Ç–≤–∏—è:"
echo "  1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª —á–µ—Ä–µ–∑ UI"
echo "  2. –§–∞–π–ª—ã —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ"
echo "  3. –ü—Ä–∏ —É—Å–ø–µ—Ö–µ —É–≤–∏–¥–∏—Ç–µ: '–ê—É–¥–∏–æ—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω'"

echo ""
echo "==============================================="
echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê –ó–ê–í–ï–†–®–ï–ù–û"
echo "===============================================" 