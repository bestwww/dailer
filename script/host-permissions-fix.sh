#!/bin/bash

# ==============================================================================
# üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê –ù–ê –•–û–°–¢-–°–ò–°–¢–ï–ú–ï
# ==============================================================================
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–ø–∫–µ audio –Ω–∞ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ
# –ù—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Å–∞–º–æ–º —Å–µ—Ä–≤–µ—Ä–µ, –∞ –ù–ï –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!

set -e

echo "==============================================="
echo "üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê"
echo "==============================================="

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤
echo "üîÑ 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
docker-compose down

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–∞–≤
echo ""
echo "üîç 2. –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ò–• –ü–†–ê–í –ù–ê –•–û–°–¢-–°–ò–°–¢–ï–ú–ï:"
echo "-----------------------------------------------"
echo "üìÇ –ü–∞–ø–∫–∞ audio –Ω–∞ —Ö–æ—Å—Ç–µ:"
ls -la ./audio/ 2>/dev/null || echo "‚ùå –ü–∞–ø–∫–∞ audio –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

# –ü–æ–ª—É—á–µ–Ω–∏–µ UID/GID nodeuser –∏–∑ Dockerfile
echo ""
echo "üë§ 3. –ü–û–õ–£–ß–ï–ù–ò–ï UID/GID –ò–ó DOCKERFILE:"
echo "-----------------------------------------------"
NODEUSER_UID=$(grep -oP 'RUN useradd.*-u \K\d+' backend/Dockerfile || echo "1001")
NODEUSER_GID=$(grep -oP 'RUN groupadd.*-g \K\d+' backend/Dockerfile || echo "1001")
echo "üìã nodeuser UID: $NODEUSER_UID"
echo "üìã nodejs GID: $NODEUSER_GID"

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ audio –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
echo ""
echo "üìÅ 4. –°–û–ó–î–ê–ù–ò–ï/–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–ê–ü–ö–ò AUDIO:"
echo "-----------------------------------------------"
if [ ! -d "./audio" ]; then
    echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏ audio..."
    mkdir -p ./audio
    echo "‚úÖ –ü–∞–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∞"
else
    echo "üìÅ –ü–∞–ø–∫–∞ audio —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
fi

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ
echo ""
echo "üîß 5. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –ù–ê –•–û–°–¢-–°–ò–°–¢–ï–ú–ï:"
echo "-----------------------------------------------"

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º UID:GID –Ω–∞–ø—Ä—è–º—É—é)
echo "üë§ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ $NODEUSER_UID:$NODEUSER_GID..."
sudo chown -R $NODEUSER_UID:$NODEUSER_GID ./audio/
echo "‚úÖ –í–ª–∞–¥–µ–ª–µ—Ü –∏–∑–º–µ–Ω–µ–Ω"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîí –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ 755..."
sudo chmod -R 755 ./audio/
echo "‚úÖ –ü—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤
echo ""
echo "‚úÖ 6. –ü–†–û–í–ï–†–ö–ê –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–• –ü–†–ê–í:"
echo "-----------------------------------------------"
echo "üìÇ –ü—Ä–∞–≤–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
ls -la ./audio/

# –°–æ–∑–¥–∞–Ω–∏–µ .gitkeep —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
echo ""
echo "üìù 7. –°–û–ó–î–ê–ù–ò–ï .GITKEEP –° –ü–†–ê–í–ò–õ–¨–ù–´–ú–ò –ü–†–ê–í–ê–ú–ò:"
echo "-----------------------------------------------"
if [ ! -f "./audio/.gitkeep" ]; then
    echo "# –ü–∞–ø–∫–∞ –¥–ª—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –∫–∞–º–ø–∞–Ω–∏–π" > ./audio/.gitkeep
    sudo chown $NODEUSER_UID:$NODEUSER_GID ./audio/.gitkeep
    sudo chmod 644 ./audio/.gitkeep
    echo "‚úÖ .gitkeep —Å–æ–∑–¥–∞–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"
else
    sudo chown $NODEUSER_UID:$NODEUSER_GID ./audio/.gitkeep
    sudo chmod 644 ./audio/.gitkeep
    echo "‚úÖ .gitkeep –æ–±–Ω–æ–≤–ª–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"
fi

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo ""
echo "üöÄ 8. –ó–ê–ü–£–°–ö –ö–û–ù–¢–ï–ô–ù–ï–†–û–í:"
echo "-----------------------------------------------"
echo "üîÑ –ó–∞–ø—É—Å–∫ —Å –ø–µ—Ä–µ—Å–±–æ—Ä–∫–æ–π backend..."
docker-compose up -d --build backend

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend (10 —Å–µ–∫)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
echo ""
echo "üîç 9. –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í –í–ù–£–¢–†–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê:"
echo "-----------------------------------------------"
echo "üìÇ –ü—Ä–∞–≤–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
docker exec dialer_backend ls -la /app/audio/

echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ü–µ—Å—Å–∞:"
docker exec dialer_backend whoami

# –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏
echo ""
echo "üß™ 10. –¢–ï–°–¢ –ó–ê–ü–ò–°–ò –§–ê–ô–õ–ê:"
echo "-----------------------------------------------"
echo "üìù –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
if docker exec dialer_backend touch /app/audio/test_write.txt; then
    echo "‚úÖ –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –£–°–ü–ï–®–ï–ù!"
    docker exec dialer_backend rm /app/audio/test_write.txt
else
    echo "‚ùå –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –ù–ï–£–î–ê–ß–ï–ù!"
fi

# –ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
echo ""
echo "üöÄ 11. –ò–¢–û–ì–û–í–´–ô –¢–ï–°–¢ –ó–ê–ì–†–£–ó–ö–ò:"
echo "-----------------------------------------------"

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞
echo "audio test content" > /tmp/final_test.mp3

# –¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏
echo "üì§ –¢–µ—Å—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏..."
UPLOAD_RESULT=$(curl -s -X POST \
    -F "audio=@/tmp/final_test.mp3" \
    -w "HTTP_CODE:%{http_code}" \
    http://localhost:3000/api/campaigns/1/audio)

echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≥—Ä—É–∑–∫–∏: $UPLOAD_RESULT"

if echo "$UPLOAD_RESULT" | grep -q "HTTP_CODE:200"; then
    echo "üéâ –£–°–ü–ï–•! –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
elif echo "$UPLOAD_RESULT" | grep -q "EACCES"; then
    echo "‚ùå –í—Å–µ –µ—â–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞"
else
    echo "‚ö†Ô∏è –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ"
fi

# –û—á–∏—Å—Ç–∫–∞
rm -f /tmp/final_test.mp3

echo ""
echo "==============================================="
echo "üìã –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢"
echo "==============================================="

echo "‚úÖ –ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:"
echo "  üìÇ –ü—Ä–∞–≤–∞ –ø–∞–ø–∫–∏ /app/audio –Ω–∞ —Ö–æ—Å—Ç-—Å–∏—Å—Ç–µ–º–µ"
echo "  üë§ –í–ª–∞–¥–µ–ª–µ—Ü —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $NODEUSER_UID:$NODEUSER_GID"
echo "  üîí –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞: 755"
echo "  üìù .gitkeep —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"

echo ""
echo "üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "  1. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
echo "  2. –§–∞–π–ª—ã —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ –ø–∞–ø–∫–µ ./audio/"
echo "  3. –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–≤–µ—Ä—å—Ç–µ: docker logs -f dialer_backend"

echo ""
echo "==============================================="
echo "‚úÖ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo "===============================================" 