#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ git merge –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –º–µ—à–∞—é—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

echo "üîß –†–ï–®–ï–ù–ò–ï –ö–û–ù–§–õ–ò–ö–¢–ê GIT MERGE"
echo "==============================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${YELLOW}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "docker-compose.yml" ]; then
    log_error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ dailer!"
    exit 1
fi

log_info "–ê–Ω–∞–ª–∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è git..."

# 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
git status

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
if [ -f "sync-server-updates.sh" ]; then
    log_info "–ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª sync-server-updates.sh, –∫–æ—Ç–æ—Ä—ã–π –º–µ—à–∞–µ—Ç merge"
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –µ—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if [ -s "sync-server-updates.sh" ]; then
        log_info "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ —Ñ–∞–π–ª–∞..."
        cp sync-server-updates.sh sync-server-updates.sh.backup.$(date +%s)
        log_success "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞"
    fi
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—ã–π —Ñ–∞–π–ª
    log_info "–£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ sync-server-updates.sh..."
    rm -f sync-server-updates.sh
    log_success "–§–∞–π–ª —É–¥–∞–ª–µ–Ω"
else
    log_info "–§–∞–π–ª sync-server-updates.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—Ä—É–≥–∏–µ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã
UNTRACKED_FILES=$(git ls-files --others --exclude-standard)
if [ -n "$UNTRACKED_FILES" ]; then
    log_info "–ù–∞–π–¥–µ–Ω—ã –¥—Ä—É–≥–∏–µ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã:"
    echo "$UNTRACKED_FILES"
    
    echo ""
    read -p "–•–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã? (y/N): " -n 1 -r
    echo ""
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        log_info "–£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤..."
        git clean -fd
        log_success "–ù–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
    else
        log_info "–ù–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã –æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å"
    fi
fi

# 5. –ü—Ä–æ–±—É–µ–º –≤—ã–ø–æ–ª–Ω–∏—Ç—å git pull
log_info "–ü–æ–ø—ã—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å git pull origin main..."
if git pull origin main; then
    log_success "Git pull –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
else
    log_error "Git pull –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
    echo ""
    echo "üîç –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø:"
    echo "=========================="
    echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: git status"
    echo "2. –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é"
    echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: git reset --hard origin/main (–û–°–¢–û–†–û–ñ–ù–û: —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)"
    exit 1
fi

# 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
echo ""
log_info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
git status

echo ""
echo "üéâ –ì–û–¢–û–í–û –ö –ü–†–û–î–û–õ–ñ–ï–ù–ò–Æ!"
echo "========================"
echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å:"
echo "1. docker-compose restart freeswitch_host"
echo "2. ./diagnose-sip-detailed.sh"

log_success "–ü—Ä–æ–±–ª–µ–º–∞ —Å git —Ä–µ—à–µ–Ω–∞!" 