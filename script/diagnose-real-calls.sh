#!/bin/bash

# üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –†–ï–ê–õ–¨–ù–´–• –ó–í–û–ù–ö–û–í –ß–ï–†–ï–ó –ü–†–û–í–ê–ô–î–ï–†–ê
# –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ SIP —Ç—Ä–∞—Ñ–∏–∫–∞ –∏ –ª–æ–≥–æ–≤

set -e

CONTAINER_NAME="freeswitch-test"

# üé® –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞
log_info() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [INFO] $1"
}

log_success() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [SUCCESS] ‚úÖ $1"
}

log_warning() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [WARNING] ‚ö†Ô∏è $1"
}

log_error() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [ERROR] ‚ùå $1"
}

echo "üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê –†–ï–ê–õ–¨–ù–´–• –ó–í–û–ù–ö–û–í"
echo "==============================="
echo ""

# –≠–¢–ê–ü 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å
echo "üìã –≠–¢–ê–ü 1: –¢–ï–ö–£–©–ò–ô –°–¢–ê–¢–£–° –°–ò–°–¢–ï–ú–´"
echo "================================="

log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å FreeSWITCH..."
FS_STATUS=$(docker exec "$CONTAINER_NAME" fs_cli -x "status" 2>/dev/null)
echo "$FS_STATUS"

log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º SIP gateway..."
GATEWAY_STATUS=$(docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway" 2>/dev/null)
echo "$GATEWAY_STATUS"

if echo "$GATEWAY_STATUS" | grep -q "NOREG.*23\."; then
    log_success "SIP trunk –ø–æ–¥–∫–ª—é—á–µ–Ω, ping —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    log_warning "–í–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å SIP trunk"
fi

# –≠–¢–ê–ü 2: –í–∫–ª—é—á–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
echo ""
echo "üìù –≠–¢–ê–ü 2: –í–ö–õ–Æ–ß–ï–ù–ò–ï –î–ï–¢–ê–õ–¨–ù–û–ì–û –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø"
echo "=========================================="

log_info "–í–∫–ª—é—á–∞–µ–º SIP trace –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞..."
docker exec "$CONTAINER_NAME" fs_cli -x "sofia profile internal siptrace on"

log_info "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º debug —É—Ä–æ–≤–µ–Ω—å..."
docker exec "$CONTAINER_NAME" fs_cli -x "console loglevel debug"

log_success "–î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ"

# –≠–¢–ê–ü 3: –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–≤–æ–Ω–∫–∞
echo ""
echo "üìû –≠–¢–ê–ü 3: –ê–ù–ê–õ–ò–ó –ü–ê–†–ê–ú–ï–¢–†–û–í –ó–í–û–ù–ö–ê"
echo "=================================="

log_info "–¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã SIP trunk:"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway internal::sip_trunk"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥–µ–∫–∏
log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–¥–µ–∫–∏..."
CODECS=$(docker exec "$CONTAINER_NAME" fs_cli -x "show codec" | grep -E "PCMU|PCMA|G729")
echo "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–¥–µ–∫–∏:"
echo "$CODECS"

# –≠–¢–ê–ü 4: –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
echo ""
echo "üß™ –≠–¢–ê–ü 4: –¢–ï–°–¢–û–í–´–ô –ó–í–û–ù–û–ö –° –õ–û–ì–ò–†–û–í–ê–ù–ò–ï–ú"
echo "========================================"

# –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
log_info "–û—á–∏—â–∞–µ–º –ª–æ–≥–∏ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞..."
docker exec "$CONTAINER_NAME" fs_cli -x "console clear"

log_info "–í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ –Ω–æ–º–µ—Ä 79206054020..."
echo ""
echo "üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∑–≤–æ–Ω–æ–∫..."

# –í—ã–ø–æ–ª–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ –∏ —Å—Ä–∞–∑—É —Å–º–æ—Ç—Ä–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
CALL_RESULT=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/79206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–º–∞–Ω–¥—ã: $CALL_RESULT"

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞
log_info "–û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –≠–¢–ê–ü 5: –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –∑–≤–æ–Ω–∫–∞
echo ""
echo "üìã –≠–¢–ê–ü 5: –ê–ù–ê–õ–ò–ó –õ–û–ì–û–í –ó–í–û–ù–ö–ê"
echo "============================="

log_info "–ü–æ—Å–ª–µ–¥–Ω–∏–µ SIP —Å–æ–æ–±—â–µ–Ω–∏—è (INVITE, –æ—Ç–≤–µ—Ç—ã):"
echo "----------------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 100" | grep -E "(INVITE|1[0-9][0-9]|2[0-9][0-9]|3[0-9][0-9]|4[0-9][0-9]|5[0-9][0-9]|6[0-9][0-9])" | tail -20
echo "----------------------------------------"

log_info "–û—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
echo "----------------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 50" | grep -i -E "(error|fail|reject|busy|timeout)" | tail -10
echo "----------------------------------------"

log_info "–£—Å–ø–µ—à–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:"
echo "----------------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 50" | grep -i -E "(answer|connect|bridge|200 OK)" | tail -10
echo "----------------------------------------"

# –≠–¢–ê–ü 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏—á–∏–Ω –æ—Ç–∫–∞–∑–∞
echo ""
echo "üîç –≠–¢–ê–ü 6: –ê–ù–ê–õ–ò–ó –ü–†–ò–ß–ò–ù –û–¢–ö–ê–ó–ê"
echo "=============================="

log_info "–ü—Ä–æ–≤–µ—Ä—è–µ–º SIP –æ—Ç–≤–µ—Ç—ã –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞..."

# –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∑–≤–æ–Ω–æ–∫ –≤ –ª–æ–≥–∞—Ö
LAST_CALL_LOGS=$(docker exec "$CONTAINER_NAME" fs_cli -x "console last 100" | grep -A5 -B5 "79206054020")
if [ -n "$LAST_CALL_LOGS" ]; then
    echo "–õ–æ–≥–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–≤–æ–Ω–∫–∞:"
    echo "$LAST_CALL_LOGS"
else
    log_warning "–õ–æ–≥–∏ –∑–≤–æ–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É gateway
log_info "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤ gateway:"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway internal::sip_trunk" | grep -E "(Calls|Failed)"

# –≠–¢–ê–ü 7: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞
echo ""
echo "üìû –≠–¢–ê–ü 7: –ü–†–û–í–ï–†–ö–ê –§–û–†–ú–ê–¢–ê –ù–û–ú–ï–†–ê"
echo "================================="

log_info "–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –Ω–æ–º–µ—Ä–∞..."

# –¢–µ—Å—Ç 1: –ü–æ–ª–Ω—ã–π —Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç
echo ""
echo "–¢–µ—Å—Ç 1: –ù–æ–º–µ—Ä —Å +7"
CALL_TEST1=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/+79206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $CALL_TEST1"
sleep 3

# –¢–µ—Å—Ç 2: –§–æ—Ä–º–∞—Ç 8
echo ""
echo "–¢–µ—Å—Ç 2: –ù–æ–º–µ—Ä —Å 8"  
CALL_TEST2=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/89206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $CALL_TEST2"
sleep 3

# –¢–µ—Å—Ç 3: –ë–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞
echo ""
echo "–¢–µ—Å—Ç 3: –ù–æ–º–µ—Ä –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞"
CALL_TEST3=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/9206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $CALL_TEST3"
sleep 3

# –≠–¢–ê–ü 8: –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
echo ""
echo "üí° –≠–¢–ê–ü 8: –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–°–¢–†–ê–ù–ï–ù–ò–Æ"
echo "===================================="

echo ""
echo "üîç –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ü–†–û–ë–õ–ï–ú–´:"
echo ""
echo "1. üìû –§–û–†–ú–ê–¢ –ù–û–ú–ï–†–ê:"
echo "   - –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (+7, 8, –±–µ–∑ –ø—Ä–µ—Ñ–∏–∫—Å–∞)"
echo "   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã—à–µ"
echo ""
echo "2. üîê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø:"
echo "   - –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–≤–æ–Ω–∫–∏ —Å –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö IP"
echo "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ IP —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫"
echo ""
echo "3. ‚öôÔ∏è –ü–ê–†–ê–ú–ï–¢–†–´ SIP:"
echo "   - –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∫–æ–¥–µ–∫–∏ –∏–ª–∏ SIP –∑–∞–≥–æ–ª–æ–≤–∫–∏"
echo "   - –ü—Ä–æ–≤–∞–π–¥–µ—Ä –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã"
echo ""
echo "4. üí∞ –ë–ê–õ–ê–ù–°/–õ–ò–ú–ò–¢–´:"
echo "   - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç—É"
echo "   - –õ–∏–º–∏—Ç—ã –Ω–∞ –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏"
echo ""
echo "5. üïê –í–†–ï–ú–Ø:"
echo "   - –í–æ–∑–º–æ–∂–Ω—ã –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∑–≤–æ–Ω–∫–æ–≤"
echo ""

echo "üéØ –ö–û–ú–ê–ù–î–´ –î–õ–Ø –î–ê–õ–¨–ù–ï–ô–®–ï–ô –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò:"
echo "====================================="
echo ""
echo "# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ª–æ–≥–∏ –∑–≤–æ–Ω–∫–∞:"
echo "docker exec $CONTAINER_NAME fs_cli -x 'console last 200' | grep -A10 -B10 '79206054020'"
echo ""
echo "# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SIP trace:"
echo "docker exec $CONTAINER_NAME fs_cli -x 'sofia profile internal siptrace on'"
echo "# –°–¥–µ–ª–∞—Ç—å –∑–≤–æ–Ω–æ–∫ –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å:"
echo "docker logs -f $CONTAINER_NAME"
echo ""
echo "# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ SIP —Å–æ–æ–±—â–µ–Ω–∏—è:"
echo "docker exec $CONTAINER_NAME tail -f /usr/local/freeswitch/log/freeswitch.log"
echo ""

echo ""
log_success "üéâ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

echo ""
echo "üìã –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "=================="
echo "1. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ"
echo "2. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è:"
echo "   - –ü—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤"
echo "   - –°—Ç–∞—Ç—É—Å–∞ IP –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ" 
echo "   - –ë–∞–ª–∞–Ω—Å–∞ –∏ –ª–∏–º–∏—Ç–æ–≤"
echo "3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏"
echo "" 