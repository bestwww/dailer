#!/bin/bash

# üîß –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–±–æ—Ä–∫–∏ FreeSWITCH Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ git pull

set -e

echo "üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–±–æ—Ä–∫–∏ FreeSWITCH Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/dailer  # –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

# –û–±–Ω–æ–≤–ª—è–µ–º—Å—è –∏–∑ git
echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ git..."
git pull origin main

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é FreeSWITCH Docker
cd docker/freeswitch

echo "üî® –ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É FreeSWITCH –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
echo "‚è±Ô∏è –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 15-30 –º–∏–Ω—É—Ç..."

# –°–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –≤—ã–≤–æ–¥–æ–º –ª–æ–≥–æ–≤
docker build -t dailer-freeswitch:test . 2>&1 | tee /tmp/freeswitch-build.log

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∫–∏
if [ $? -eq 0 ]; then
    echo "‚úÖ –°–±–æ—Ä–∫–∞ FreeSWITCH –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    docker run --rm -d --name freeswitch-test \
        -p 5060:5060/udp \
        -p 8021:8021 \
        dailer-freeswitch:test
    
    # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
    sleep 10
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Event Socket
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Event Socket..."
    if nc -z localhost 8021; then
        echo "‚úÖ Event Socket –¥–æ—Å—Ç—É–ø–µ–Ω!"
    else
        echo "‚ùå Event Socket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    docker stop freeswitch-test
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–±—Ä–∞–∑–µ
    echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—Ä–∞–∑–µ:"
    docker images | grep dailer-freeswitch
    
    echo ""
    echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
    echo "üí° –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é: dailer-freeswitch:test"
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ FreeSWITCH –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞!"
    echo "üìã –õ–æ–≥–∏ —Å–±–æ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ /tmp/freeswitch-build.log"
    echo ""
    echo "üîç –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
    tail -20 /tmp/freeswitch-build.log
    exit 1
fi 