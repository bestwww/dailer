#!/bin/bash

# üîß –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è git –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

set -e

echo "üîß === –†–ê–ó–†–ï–®–ï–ù–ò–ï GIT –ö–û–ù–§–õ–ò–ö–¢–û–í –ù–ê –°–ï–†–í–ï–†–ï ==="
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [GIT] $1"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [[ ! -d ".git" ]]; then
    log "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–∞ git –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è!"
    echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ: cd dailer"
    exit 1
fi

log "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å git
log "üìä –ü—Ä–æ–≤–µ—Ä—è–µ–º git —Å—Ç–∞—Ç—É—Å..."
git status

echo
log "üîç –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ —Ñ–∞–π–ª—ã:"
echo "   - debug-audio-upload.sh"
echo "   - debug-docker.sh" 
echo "   - debug-timeout-fix.sh"
echo "   - deploy-test.sh"
echo "   - fix-audio-permissions.sh"
echo "   - freeswitch/conf/dialplan/default.xml"
echo "   - host-permissions-fix.sh"
echo "   - test-freeswitch-packages.sh"

echo
read -p "–•–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º? (y/N): " save_local

if [[ $save_local == [yY] ]]; then
    log "üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash..."
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞–∂–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
    log "üìã –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏..."
    cp freeswitch/conf/dialplan/default.xml freeswitch/conf/dialplan/default.xml.backup.$(date +%s) 2>/dev/null || true
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ stash
    git stash push -m "–õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º $(date)"
    
    log "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ git stash"
else
    log "‚ö†Ô∏è –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    
    # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤–∞–∂–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    cp freeswitch/conf/dialplan/default.xml freeswitch/conf/dialplan/default.xml.backup.$(date +%s) 2>/dev/null || true
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    git reset --hard HEAD
    
    log "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—à–µ–Ω—ã"
fi

echo
log "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º git pull..."
if git pull origin main; then
    log "‚úÖ Git pull –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
else
    log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ git pull"
    exit 1
fi

echo
log "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üÜï –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:"
if [[ -f "test-calls.sh" ]]; then
    log "‚úÖ test-calls.sh –Ω–∞–π–¥–µ–Ω"
    chmod +x test-calls.sh
    log "üîß –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–ª—è test-calls.sh"
else
    log "‚ùå test-calls.sh –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

if [[ -f "TESTING_GUIDE.md" ]]; then
    log "‚úÖ TESTING_GUIDE.md –Ω–∞–π–¥–µ–Ω"
else
    log "‚ùå TESTING_GUIDE.md –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

if [[ -f "audio/example_1.mp3" ]]; then
    log "‚úÖ audio/example_1.mp3 –Ω–∞–π–¥–µ–Ω ($(ls -lh audio/example_1.mp3 | awk '{print $5}'))"
else
    log "‚ùå audio/example_1.mp3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è FreeSWITCH –¥–∏–∞–ª–ø–ª–∞–Ω–∞..."
if grep -q "test_internal_1204" freeswitch/conf/dialplan/default.xml 2>/dev/null; then
    log "‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ (1204-1206) –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –¥–∏–∞–ª–ø–ª–∞–Ω–µ"
else
    log "‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –¥–∏–∞–ª–ø–ª–∞–Ω–µ"
fi

if grep -q "79206054020" freeswitch/conf/dialplan/default.xml 2>/dev/null; then
    log "‚úÖ –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ 79206054020 –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
else
    log "‚ö†Ô∏è –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

echo
if [[ $save_local == [yY] ]]; then
    log "üí° –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –õ–û–ö–ê–õ–¨–ù–´–• –ò–ó–ú–ï–ù–ï–ù–ò–ô:"
    echo "   git stash list                    # –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "   git stash pop                     # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "   git stash apply stash@{0}         # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    echo "   git stash drop                    # –£–¥–∞–ª–∏—Ç—å stash –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è"
fi

echo
log "üìÅ –†–ï–ó–ï–†–í–ù–´–ï –ö–û–ü–ò–ò:"
echo "   –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Å —Å—É—Ñ—Ñ–∏–∫—Å–æ–º .backup.timestamp"
ls -la freeswitch/conf/dialplan/*.backup.* 2>/dev/null || echo "   –ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π"

echo
log "üöÄ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "   1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã:     docker compose ps"
echo "   2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å FreeSWITCH:        docker compose restart freeswitch"
echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:          ./test-calls.sh"

echo
log "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!" 