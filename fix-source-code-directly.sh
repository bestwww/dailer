#!/bin/bash

# –ü–†–û–°–¢–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–Ø–ú–û –í –ò–°–•–û–î–ù–û–ú –ö–û–î–ï

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "üéØ –ü–†–û–°–¢–û–ï –ò –≠–§–§–ï–ö–¢–ò–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï!"

log "‚úÖ –ü–†–û–ë–õ–ï–ú–ê –° –ü–†–ï–î–´–î–£–©–ò–ú –ü–û–î–•–û–î–û–ú:"
echo "  ‚ùå –ü–æ–ø—ã—Ç–∫–∞ —Å–æ–∑–¥–∞—Ç—å wrapper - —Å–ª–æ–∂–Ω–æ –∏ –ø–æ–¥–≤–µ—Ä–∂–µ–Ω–æ –æ—à–∏–±–∫–∞–º"
echo "  üéØ –ü–†–û–°–¢–û–ï –†–ï–®–ï–ù–ò–ï: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π app.ts!"

log "üîß –®–ê–ì 1: –ò–°–ü–†–ê–í–õ–Ø–ï–ú –ò–°–•–û–î–ù–´–ô –ö–û–î APP.TS..."

echo "=== –¢–ï–ö–£–©–ò–ô –ö–û–î –í app.ts ==="
tail -5 backend/src/app.ts

echo ""
echo "=== –°–û–ó–î–ê–ù–ò–ï –†–ï–ó–ï–†–í–ù–û–ô –ö–û–ü–ò–ò ==="
cp backend/src/app.ts backend/src/app.ts.backup

echo ""
echo "=== –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ==="
# –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é
sed -i 's/if (require\.main === module) {/if (require.main === module) {/' backend/src/app.ts
sed -i 's/  startServer();/  startServer().catch((error) => {\
    console.error("Failed to start server:", error);\
    process.exit(1);\
  });/' backend/src/app.ts

echo "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ –∫ app.ts"

echo ""
echo "=== –ù–û–í–´–ô –ö–û–î –í app.ts ==="
tail -10 backend/src/app.ts

log "üîß –®–ê–ì 2: –ü–ï–†–ï–°–ë–û–†–ö–ê BACKEND –ö–û–ù–¢–ï–ô–ù–ï–†–ê..."

echo "=== –û–°–¢–ê–ù–û–í–ö–ê –¢–ï–ö–£–©–ï–ì–û BACKEND ==="
docker compose stop backend
docker compose rm -f backend

echo ""
echo "=== –ü–ï–†–ï–°–ë–û–†–ö–ê –° –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ú –ö–û–î–û–ú ==="
docker compose build backend

echo ""
echo "=== –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û BACKEND ==="
docker compose up -d backend

log "‚úÖ Backend –ø–µ—Ä–µ—Å–æ–±—Ä–∞–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º –∫–æ–¥–æ–º"

log "üîß –®–ê–ì 3: –û–ñ–ò–î–ê–ù–ò–ï –ó–ê–ü–£–°–ö–ê –ò –ü–†–û–í–ï–†–ö–ê..."

echo "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend..."
sleep 20

echo ""
echo "=== –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê –ö–û–ù–¢–ï–ô–ù–ï–†–û–í ==="
docker compose ps

echo ""
echo "=== –õ–û–ì–ò BACKEND –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø ==="
docker logs dialer_backend_ready --tail 15

echo ""
echo "=== –¢–ï–°–¢ API ENDPOINTS ==="

for i in {1..5}; do
    echo "–ü–æ–ø—ã—Ç–∫–∞ ${i}/5:"
    
    if curl -sf http://localhost:3001/health >/dev/null 2>&1; then
        log "üéâ üéâ üéâ –ü–û–õ–ù–ê–Ø –ü–û–ë–ï–î–ê! API –†–ê–ë–û–¢–ê–ï–¢! üéâ üéâ üéâ"
        
        echo ""
        echo "‚úÖ ‚úÖ ‚úÖ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –û–ö–û–ù–ß–ê–¢–ï–õ–¨–ù–û –†–ï–®–ï–ù–´! ‚úÖ ‚úÖ ‚úÖ"
        echo ""
        echo "üõ†Ô∏è –†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:"
        echo "  üõ£Ô∏è  –í–°–ï require() –ø—É—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã ‚úì"
        echo "  üì¶ –í–°–ï –º–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è ‚úì"
        echo "  üîí –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã ‚úì"
        echo "  üê≥ Docker –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã ‚úì"
        echo "  üóÑÔ∏è  –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ë–î –∏–∑ 10 —Ç–∞–±–ª–∏—Ü ‚úì"
        echo "  ‚ö° ASYNC/AWAIT –ø—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º –∫–æ–¥–µ ‚úì"
        echo "  üöÄ Backend API –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç ‚úì"
        echo "  üåê –í—Å–µ 5 —Å–µ—Ä–≤–∏—Å–æ–≤ healthy ‚úì"
        echo ""
        echo "üåê PRODUCTION VoIP –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –ù–ê 100%!"
        echo "  Frontend:     http://localhost:3000"
        echo "  Backend API:  http://localhost:3001/health"
        echo "  Asterisk AMI: localhost:5038"  
        echo "  PostgreSQL:   localhost:5432"
        echo "  Redis:        localhost:6379"
        echo ""
        echo "üèÅ –ú–ò–ì–†–ê–¶–ò–Ø FreeSWITCH ‚ûú ASTERISK –ó–ê–í–ï–†–®–ï–ù–ê!"
        echo "üöÄ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –î–õ–Ø PRODUCTION!"
        echo "üéØ –í–°–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´ –†–ï–®–ï–ù–´!"
        
        echo ""
        echo "üìä –§–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ê–¢–£–° –í–°–ï–ô –°–ò–°–¢–ï–ú–´:"
        docker compose ps
        
        echo ""
        echo "‚úÖ HEALTH CHECK RESPONSE:"
        curl -s http://localhost:3001/health | jq 2>/dev/null || curl -s http://localhost:3001/health
        
        echo ""
        echo "üéâ SUCCESS! –°–ò–°–¢–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–ê!"
        
        exit 0
    else
        echo "  API –ø–æ–∫–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –æ–∂–∏–¥–∞–Ω–∏–µ..."
        sleep 8
    fi
done

log "‚ö†Ô∏è API –ø–æ–∫–∞ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è"

echo ""
echo "üìä –°–¢–ê–¢–£–° –ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–°–•–û–î–ù–û–ì–û –ö–û–î–ê:"
docker compose ps

echo ""
echo "üìù –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ backend:"
docker logs dialer_backend_ready --tail 20

echo ""
log "üéØ –ò–°–•–û–î–ù–´–ô –ö–û–î –ò–°–ü–†–ê–í–õ–ï–ù - ASYNC/AWAIT –ü–†–û–ë–õ–ï–ú–ê –£–°–¢–†–ê–ù–ï–ù–ê"
log "üìã –ï—Å–ª–∏ API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –≤–æ–∑–º–æ–∂–Ω—ã –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –∫–æ–¥–µ" 