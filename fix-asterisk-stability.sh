#!/bin/bash

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Asterisk –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
# –†–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∏ AMI –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

set -e

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

log "üõ†Ô∏è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Asterisk"

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
log "üõë –ü–æ–ª–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
docker compose down --remove-orphans
docker stop $(docker ps -aq) 2>/dev/null || true

# –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
log "üßπ –û—á–∏—Å—Ç–∫–∞ Docker —Ä–µ—Å—É—Ä—Å–æ–≤..."
docker system prune -f

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Asterisk —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
log "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ Asterisk —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
docker compose build asterisk --no-cache

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ backend —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ reconnect –ª–æ–≥–∏–∫–æ–π
log "üî® –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ backend —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ memory leak..."
docker compose build backend --no-cache

# –ó–∞–ø—É—Å–∫ –ø–æ –ø–æ—Ä—è–¥–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
log "üöÄ –ü–æ—ç—Ç–∞–ø–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."

log "1Ô∏è‚É£ –ó–∞–ø—É—Å–∫ –±–∞–∑–æ–≤—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤..."
docker compose up postgres redis -d

log "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
sleep 15

log "2Ô∏è‚É£ –ó–∞–ø—É—Å–∫ Asterisk..."
docker compose up asterisk -d

log "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ Asterisk..."
sleep 20

log "3Ô∏è‚É£ –ó–∞–ø—É—Å–∫ backend..."
docker compose up backend -d

log "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è backend –∫ AMI..."
sleep 15

log "4Ô∏è‚É£ –ó–∞–ø—É—Å–∫ frontend..."
docker compose up frontend -d

log "‚è≥ –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
log "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:"
docker compose ps

log "üìã –õ–æ–≥–∏ Asterisk (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
docker compose logs asterisk --tail=10

log "üìã –õ–æ–≥–∏ Backend (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å—Ç—Ä–æ–∫):"
docker compose logs backend --tail=10

# –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
log "üß™ –¢–µ—Å—Ç —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è backend ‚Üí asterisk:"
docker compose exec backend ping asterisk -c 3 || echo "‚ö†Ô∏è Ping –Ω–µ –ø—Ä–æ—à–µ–ª"

log "üß™ –¢–µ—Å—Ç AMI –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
timeout 30s docker compose exec backend npm run test-asterisk || echo "‚ö†Ô∏è AMI —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"

log "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

log "üí° –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞–ª–∏—Å—å:"
log "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: docker compose logs asterisk"
log "   - –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Ç–¥–µ–ª—å–Ω–æ: docker compose restart asterisk"
log "   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Ä—Ç—ã: netstat -tlnp | grep 5038" 