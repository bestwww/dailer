# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ PROTOCOL_ERROR –≤ FreeSWITCH

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

–í –ª–æ–≥–∞—Ö FreeSWITCH –Ω–∞–±–ª—é–¥–∞–ª–∞—Å—å –æ—à–∏–±–∫–∞ `PROTOCOL_ERROR` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏—Å—Ö–æ–¥—è—â–∏–µ –∑–≤–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:

```
1ad0e535-72fa-4526-ba4e-1f0952be75be 2025-07-19 16:47:33.645464 99.80% [DEBUG] switch_ivr_originate.c:4056 Originate Resulted in Error Cause: 111 [PROTOCOL_ERROR]
```

## üïµÔ∏è –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –æ—à–∏–±–∫–∏ PROTOCOL_ERROR:

1. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Caller ID**: –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å —Ä–∞–∑–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
   - –í –ª–æ–≥–∞—Ö: `79058615815`
   - –í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: `79058615815`

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–æ—Å—å –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ gateway
   - –ü—Ä–æ–±–ª–µ–º–∞: `sofia/external/$1@62.141.121.197:5070`
   - –†–µ—à–µ–Ω–∏–µ: `sofia/gateway/sip_trunk/$1`

3. **–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ SIP –∑–∞–≥–æ–ª–æ–≤–∫–∏**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ `from-domain` –∏ –≤–Ω–µ—à–Ω–µ–≥–æ IP

## ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –î–∏–∞–ª–ø–ª–∞–Ω (`freeswitch/conf/dialplan/default.xml`)
```xml
<!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Caller ID -->
<action application="set" data="effective_caller_id_name=Dailer"/>
<action application="set" data="effective_caller_id_number=79058615815"/>
<action application="set" data="sip_from_user=79058615815"/>
<action application="set" data="sip_from_host=46.173.16.147"/>

<!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ gateway –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
<action application="bridge" data="sofia/gateway/sip_trunk/$1"/>
```

### 2. Sofia SIP Gateway (`freeswitch/conf/autoload_configs/sofia.conf.xml`)
```xml
<!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: Caller ID —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∞–º -->
<param name="from-user" value="79058615815"/>
<param name="from-domain" value="46.173.16.147"/>

<!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –í–Ω–µ—à–Ω–∏–π IP –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã -->
<param name="ext-rtp-ip" value="46.173.16.147"/>
<param name="ext-sip-ip" value="46.173.16.147"/>
```

### 3. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (`freeswitch/conf/vars.xml`)
```xml
<!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä -->
<X-PRE-PROCESS cmd="set" data="outbound_caller_id_number=79058615815"/>
<X-PRE-PROCESS cmd="set" data="conference_auto_outcall_caller_id_number=79058615815"/>
```

## üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
```bash
./fix-freeswitch-protocol-error.sh
```

### –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:
```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FreeSWITCH
docker compose stop freeswitch

# 2. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å FreeSWITCH
docker compose up -d freeswitch

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker exec dialer_freeswitch fs_cli -x "status"
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ gateway:
```bash
docker exec dialer_freeswitch fs_cli -x "sofia status gateway sip_trunk"
```

### –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫:
```bash
docker exec dialer_freeswitch fs_cli -x "originate sofia/gateway/sip_trunk/79206054020 &echo"
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤:
```bash
docker logs -f dialer_freeswitch
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### ‚úÖ –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚ùå `PROTOCOL_ERROR` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏—Å—Ö–æ–¥—è—â–µ–º –∑–≤–æ–Ω–∫–µ
- ‚ùå –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ Caller ID –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- ‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É –±–µ–∑ gateway

### ‚úÖ –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Caller ID: `79058615815`
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ `sofia/gateway/sip_trunk`
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ SIP –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–º–µ–Ω–∞
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å IP-based –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ PROTOCOL_ERROR –≤—Å–µ –µ—â–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ç–µ–≤—É—é —Å–≤—è–∑–Ω–æ—Å—Ç—å:**
   ```bash
   docker exec dialer_freeswitch ping -c 3 62.141.121.197
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–Ω–µ—à–Ω–∏–π IP —Å–µ—Ä–≤–µ—Ä–∞:**
   ```bash
   curl -s ifconfig.me
   # –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å: 46.173.16.147
   ```

3. **–í–∫–ª—é—á–∏—Ç–µ SIP —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É:**
   ```bash
   docker exec dialer_freeswitch fs_cli -x "sofia profile external siptrace on"
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:**
   - IP whitelist –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å: `46.173.16.147`
   - –ü–æ—Ä—Ç SIP: `5070`
   - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–¥–µ–∫–æ–≤: `PCMU, PCMA`

## üèÜ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```
üéØ Caller ID: 79058615815
üåê SIP Provider: 62.141.121.197:5070
üè† Local IP: 46.173.16.147
üîß Gateway: sip_trunk (IP-based, no registration)
üìû –î–∏–∞–ª–ø–ª–∞–Ω: sofia/gateway/sip_trunk/{number}
```

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏

1. **IP-based –ø—Ä–æ–≤–∞–π–¥–µ—Ä**: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞ (`register=false`)
2. **Caller ID —Ñ–æ—Ä–º–∞—Ç**: –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `7` (—Ä–æ—Å—Å–∏–π—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
3. **Gateway vs Direct**: –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ gateway –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

---

**‚úÖ –°—Ç–∞—Ç—É—Å:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ  
**üìÖ –î–∞—Ç–∞:** 19 –∏—é–ª—è 2025  
**üë®‚Äçüíª –ê–≤—Ç–æ—Ä:** AI Assistant (Claude Sonnet 4)  

**üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `fix-freeswitch-protocol-error.sh` - –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `freeswitch/conf/dialplan/default.xml` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥–∏–∞–ª–ø–ª–∞–Ω
- `freeswitch/conf/autoload_configs/sofia.conf.xml` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è SIP
- `freeswitch/conf/vars.xml` - –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ 