#!/bin/bash

# üîç –ë–´–°–¢–†–´–ô –ê–ù–ê–õ–ò–ó SIP –õ–û–ì–û–í
# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—á–µ–º—É –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –∑–≤–æ–Ω–∫–∏

CONTAINER_NAME="freeswitch-test"

echo "üîç –ë–´–°–¢–†–´–ô –ê–ù–ê–õ–ò–ó SIP –ü–†–û–ë–õ–ï–ú"
echo "============================"
echo ""

echo "üö® –û–ë–ù–ê–†–£–ñ–ï–ù–û: FailedCallsOUT 3/3 - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –í–°–ï –∑–≤–æ–Ω–∫–∏!"
echo ""

echo "üìã –ê–ù–ê–õ–ò–ó –ü–û–°–õ–ï–î–ù–ò–• SIP –õ–û–ì–û–í"
echo "============================="

echo ""
echo "1. üîç –ü–û–ò–°–ö SIP –û–®–ò–ë–û–ö –í –õ–û–ì–ê–•:"
echo "------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 200" | grep -i -E "(4[0-9][0-9]|5[0-9][0-9]|6[0-9][0-9])" | tail -10

echo ""
echo "2. üîç –ü–û–°–õ–ï–î–ù–ò–ï INVITE –°–û–û–ë–©–ï–ù–ò–Ø:"
echo "--------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 200" | grep -A3 -B1 "INVITE" | tail -20

echo ""
echo "3. üîç –û–¢–í–ï–¢–´ –ü–†–û–í–ê–ô–î–ï–†–ê:"
echo "----------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 200" | grep -E "(1[0-9][0-9]|2[0-9][0-9]|3[0-9][0-9]|4[0-9][0-9]|5[0-9][0-9]|6[0-9][0-9]) " | tail -15

echo ""
echo "4. üîç –ü–û–õ–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ü–û–°–õ–ï–î–ù–ï–ì–û –ó–í–û–ù–ö–ê:"
echo "---------------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 100" | grep -A10 -B5 "79206054020"

echo ""
echo "5. üìä –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê GATEWAY:"
echo "----------------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia status gateway internal::sip_trunk verbose"

echo ""
echo "6. üß™ –ù–û–í–´–ô –¢–ï–°–¢–û–í–´–ô –ó–í–û–ù–û–ö –° SIP TRACE:"
echo "---------------------------------------"
echo "–í–∫–ª—é—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π SIP trace..."
docker exec "$CONTAINER_NAME" fs_cli -x "sofia profile internal siptrace on"
docker exec "$CONTAINER_NAME" fs_cli -x "sofia loglevel all 9"

echo ""
echo "–î–µ–ª–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫..."
CALL_RESULT=$(docker exec "$CONTAINER_NAME" fs_cli -x "originate sofia/gateway/sip_trunk/79206054020 &echo" 2>&1)
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: $CALL_RESULT"

echo ""
echo "–ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–≤–æ–Ω–∫–∞..."
sleep 5

echo ""
echo "üìã SIP TRACE –ù–û–í–û–ì–û –ó–í–û–ù–ö–ê:"
echo "--------------------------"
docker exec "$CONTAINER_NAME" fs_cli -x "console last 50" | grep -A20 -B5 "send.*INVITE\|recv.*SIP"

echo ""
echo "üí° –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –ò –†–ï–®–ï–ù–ò–Ø:"
echo "==============================="
echo ""
echo "–ü–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ FailedCallsOUT: 3/3 - –ø—Ä–æ–±–ª–µ–º—ã:"
echo ""
echo "1. üîê IP –ù–ï –ê–í–¢–û–†–ò–ó–û–í–ê–ù:"
echo "   - –ö–æ–¥ 403 Forbidden"
echo "   - –í–∞—à IP 46.173.16.147 –Ω–µ –≤ –±–µ–ª–æ–º —Å–ø–∏—Å–∫–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞"
echo ""
echo "2. üìû –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô –§–û–†–ú–ê–¢ –ù–û–ú–ï–†–ê:"
echo "   - –ö–æ–¥ 404 Not Found"  
echo "   - –ü—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç 79206054020"
echo ""
echo "3. üí∞ –ù–ï–¢ –ë–ê–õ–ê–ù–°–ê/–ë–õ–û–ö–ò–†–û–í–ö–ê:"
echo "   - –ö–æ–¥ 402 Payment Required"
echo "   - –ö–æ–¥ 503 Service Unavailable"
echo ""
echo "4. ‚öôÔ∏è –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ï SIP –ü–ê–†–ê–ú–ï–¢–†–´:"
echo "   - –ö–æ–¥ 488 Not Acceptable Here (–∫–æ–¥–µ–∫–∏)"
echo "   - –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏"
echo ""

echo ""
echo "üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
echo "=================="
echo "1. –ù–∞–π–¥–∏—Ç–µ –∫–æ–¥ –æ—à–∏–±–∫–∏ –≤ SIP trace –≤—ã—à–µ"
echo "2. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º –¥–ª—è:"
echo "   - –î–æ–±–∞–≤–ª–µ–Ω–∏—è IP 46.173.16.147 –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫"
echo "   - –£—Ç–æ—á–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–æ–≤"
echo "   - –ü—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–ª–∞–Ω—Å–∞"
echo "3. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–∑–º–µ–Ω–∏–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"

echo ""
echo "‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω!" 