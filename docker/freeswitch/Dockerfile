# üîí –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–∑ FreeSWITCH
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º Debian (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
FROM debian:12-slim

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–∞
LABEL maintainer="Dailer Team"
LABEL description="Secure FreeSWITCH for Dailer Project"
LABEL version="1.10.12"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ FreeSWITCH
RUN apt-get update && apt-get install -y \
    # –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
    build-essential \
    cmake \
    automake \
    autoconf \
    libtool \
    libtool-bin \
    pkg-config \
    git \
    wget \
    curl \
    netcat-openbsd \
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
    autotools-dev \
    bison \
    zlib1g-dev \
    libjpeg-dev \
    libncurses5-dev \
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ FreeSWITCH
    libssl-dev \
    libcurl4-openssl-dev \
    libpcre3-dev \
    libspeex-dev \
    libspeexdsp-dev \
    libedit-dev \
    libtiff5-dev \
    yasm \
    # –ê—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ –∫–æ–¥–µ–∫–∏
    libavformat-dev \
    libswscale-dev \
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    libsqlite3-dev \
    # UUID –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    uuid-dev \
    # LDAP –ø–æ–¥–¥–µ—Ä–∂–∫–∞
    libldap2-dev \
    # SpanDSP - –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è FreeSWITCH! –°–æ–±–∏—Ä–∞–µ–º –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ FreeSWITCH
    libtiff-dev \
    libaudiofile-dev \
    libfftw3-dev \
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—É–¥–∏–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    libasound2-dev \
    # PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    libpq-dev \
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–¥–µ–∫–∏ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    libopus-dev \
    libvorbis-dev \
    libflac-dev \
    libmp3lame-dev \
    # –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    libgcrypt20-dev \
    libgnutls28-dev \
    # XML –æ–±—Ä–∞–±–æ—Ç–∫–∞
    libxml2-dev \
    libxslt1-dev \
    # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    netcat-openbsd \
    telnet \
    net-tools \
    iputils-ping \
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# –°–Ω–∞—á–∞–ª–∞ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º SpanDSP –∏ Sofia-SIP –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ FreeSWITCH
RUN cd /usr/src && \
    echo "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–¥—ã SpanDSP..." && \
    git clone https://github.com/freeswitch/spandsp.git && \
    cd spandsp && \
    echo "üöÄ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SpanDSP..." && \
    echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏ SpanDSP..." && \
    autoconf --version && \
    automake --version && \
    libtool --version && \
    if [ -f ./autogen.sh ]; then ./autogen.sh; elif [ -f ./bootstrap.sh ]; then ./bootstrap.sh; else echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!"; exit 1; fi && \
    ./configure --prefix=/usr/local && \
    echo "üî® –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º SpanDSP..." && \
    make -j$(nproc) && \
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º SpanDSP..." && \
    make install && \
    echo "üîó –û–±–Ω–æ–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∫–µ—à..." && \
    ldconfig && \
    echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è SpanDSP..." && \
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/spandsp.conf && \
    ldconfig && \
    echo "‚úÖ SpanDSP —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!" && \
    cd /usr/src && rm -rf spandsp && \
    echo "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–¥—ã Sofia-SIP..." && \
    git clone https://github.com/freeswitch/sofia-sip.git && \
    cd sofia-sip && \
    echo "üöÄ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Sofia-SIP..." && \
    echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏ Sofia-SIP..." && \
    autoconf --version && \
    automake --version && \
    libtool --version && \
    if [ -f ./autogen.sh ]; then ./autogen.sh; elif [ -f ./bootstrap.sh ]; then ./bootstrap.sh; else echo "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏!"; exit 1; fi && \
    ./configure --prefix=/usr/local && \
    echo "üî® –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º Sofia-SIP..." && \
    make -j$(nproc) && \
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Sofia-SIP..." && \
    make install && \
    echo "üîó –û–±–Ω–æ–≤–ª—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ—á–Ω—ã–π –∫–µ—à..." && \
    ldconfig && \
    echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è Sofia-SIP..." && \
    echo "/usr/local/lib" >> /etc/ld.so.conf.d/sofia-sip.conf && \
    ldconfig && \
    echo "‚úÖ Sofia-SIP —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!" && \
    cd /usr/src && rm -rf sofia-sip

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ SpanDSP –∏ Sofia-SIP
ENV PKG_CONFIG_PATH="/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH" \
    LD_LIBRARY_PATH="/usr/local/lib:$LD_LIBRARY_PATH"

# –¢–µ–ø–µ—Ä—å –∫–æ–º–ø–∏–ª–∏—Ä—É–µ–º FreeSWITCH –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ (–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨!)
RUN cd /usr/src && \
    echo "üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –∫–æ–¥—ã FreeSWITCH..." && \
    git clone https://github.com/signalwire/freeswitch.git -b v1.10.12 && \
    cd freeswitch && \
    echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å–±–æ—Ä–∫–∏..." && \
    autoconf --version && \
    automake --version && \
    libtool --version && \
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º bootstrap..." && \
    ./bootstrap.sh -j && \
    echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é..." && \
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º SpanDSP..." && \
    pkg-config --exists spandsp && echo "‚úÖ SpanDSP –Ω–∞–π–¥–µ–Ω" || echo "‚ö†Ô∏è SpanDSP –Ω–µ –Ω–∞–π–¥–µ–Ω" && \
    find /usr/local -name "*spandsp*" 2>/dev/null | head -5 && \
    echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Sofia-SIP..." && \
    pkg-config --exists sofia-sip-ua && echo "‚úÖ Sofia-SIP –Ω–∞–π–¥–µ–Ω" || echo "‚ö†Ô∏è Sofia-SIP –Ω–µ –Ω–∞–π–¥–µ–Ω" && \
    find /usr/local -name "*sofia*" 2>/dev/null | head -5 && \
    ./configure \
        --prefix=/usr/local/freeswitch \
        --sysconfdir=/etc/freeswitch \
        --enable-core-libedit-support \
        --disable-dependency-tracking \
        --enable-zrtp \
        --disable-fhs \
        --with-spandsp=/usr/local \
        --with-sofia-sip=/usr/local \
        --enable-mod-spandsp \
        --enable-mod-fax \
        --enable-mod-t38gateway \
        --disable-mod-enum \
        --disable-libvpx \
        --without-java \
        --without-python && \
    echo "üî® –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º FreeSWITCH (—ç—Ç–æ –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è)..." && \
    make -j$(nproc) && \
    echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FreeSWITCH..." && \
    make install && \
    echo "üßπ –û—á–∏—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞..." && \
    cd / && rm -rf /usr/src/freeswitch && \
    echo "‚úÖ FreeSWITCH —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!" && \
    echo "üßπ –£–¥–∞–ª—è–µ–º –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—ã –∏ dev-–ø–∞–∫–µ—Ç—ã –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞..." && \
    apt-get purge -y \
        build-essential \
        cmake \
        automake \
        autoconf \
        libtool-bin \
        pkg-config \
        git \
        wget \
        curl && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /tmp/* && \
    rm -rf /var/tmp/* && \
    echo "üì¶ –†–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —É–º–µ–Ω—å—à–µ–Ω (–æ—Ç ~1.2GB –¥–æ ~300-400MB)!"

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è freeswitch –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -r -s /bin/false freeswitch

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ FreeSWITCH
RUN mkdir -p /usr/local/freeswitch/log \
             /usr/local/freeswitch/db \
             /usr/local/freeswitch/storage \
             /usr/local/freeswitch/recordings \
             /usr/local/freeswitch/run

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
RUN chown -R freeswitch:freeswitch /usr/local/freeswitch \
                                   /etc/freeswitch

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Event Socket
RUN echo '<?xml version="1.0" encoding="UTF-8"?>' > /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '<configuration name="event_socket.conf" description="Socket Client">' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  <settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="nat-map" value="false"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-ip" value="0.0.0.0"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-port" value="8021"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    ESL_PASSWORD=$(openssl rand -hex 16) && \
    echo "üîê –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è Event Socket: $ESL_PASSWORD" && \
    echo "    <param name=\"password\" value=\"$ESL_PASSWORD\"/>" >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo "üîê Event Socket –ø–∞—Ä–æ–ª—å: $ESL_PASSWORD" > /var/log/freeswitch-esl-password.log && \
    echo '    <param name="apply-inbound-acl" value="admin_acl"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="stop-on-bind-error" value="true"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  </settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo "üîí –°–æ–∑–¥–∞–µ–º ACL –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞..." && \
    mkdir -p /etc/freeswitch/autoload_configs && \
    echo '<?xml version="1.0" encoding="utf-8"?>' > /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '<configuration name="acl.conf" description="Network Access Control List">' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '  <network-lists>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '    <list name="admin_acl" default="deny">' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '      <node type="allow" cidr="127.0.0.1/32"/>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '      <node type="allow" cidr="10.0.0.0/8"/>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '      <node type="allow" cidr="172.16.0.0/12"/>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '      <node type="allow" cidr="192.168.0.0/16"/>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '    </list>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '  </network-lists>' >> /etc/freeswitch/autoload_configs/acl.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/acl.conf.xml

# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π modules.conf.xml –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
RUN echo '<?xml version="1.0" encoding="UTF-8"?>' > /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '<configuration name="modules.conf" description="Modules">' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '  <modules>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_event_socket"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_sofia"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_commands"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_console"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_dptools"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_dialplan_xml"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '  </modules>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/modules.conf.xml

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
RUN chown -R freeswitch:freeswitch /etc/freeswitch

# –î–æ–±–∞–≤–ª—è–µ–º FreeSWITCH –≤ PATH
ENV PATH="/usr/local/freeswitch/bin:${PATH}"

# Expose —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã FreeSWITCH
EXPOSE 5060/udp 5080/udp 8021/tcp 16384-16394/udp

# –°–æ–∑–¥–∞–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
RUN echo '#!/bin/bash' > /docker-entrypoint.sh && \
    echo 'set -e' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏' >> /docker-entrypoint.sh && \
    echo 'sleep 5' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –í—ã–≤–æ–¥–∏–º –ø–∞—Ä–æ–ª—å Event Socket –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' >> /docker-entrypoint.sh && \
echo 'echo "üîê === Event Socket –ø–∞—Ä–æ–ª—å ===" ' >> /docker-entrypoint.sh && \
echo 'if [ -f /var/log/freeswitch-esl-password.log ]; then' >> /docker-entrypoint.sh && \
echo '    cat /var/log/freeswitch-esl-password.log' >> /docker-entrypoint.sh && \
echo 'else' >> /docker-entrypoint.sh && \
echo '    echo "‚ö†Ô∏è –§–∞–π–ª —Å –ø–∞—Ä–æ–ª–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω"' >> /docker-entrypoint.sh && \
echo 'fi' >> /docker-entrypoint.sh && \
echo 'echo "üîê =========================="' >> /docker-entrypoint.sh && \
echo '' >> /docker-entrypoint.sh && \
echo '# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞' >> /docker-entrypoint.sh && \
echo 'chown -R freeswitch:freeswitch /usr/local/freeswitch /etc/freeswitch' >> /docker-entrypoint.sh && \
echo '' >> /docker-entrypoint.sh && \
    echo '# –ó–∞–ø—É—Å–∫–∞–µ–º FreeSWITCH –≤ foreground —Ä–µ–∂–∏–º–µ' >> /docker-entrypoint.sh && \
    echo 'exec /usr/local/freeswitch/bin/freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -conf /etc/freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -log /usr/local/freeswitch/log \' >> /docker-entrypoint.sh && \
    echo '    -db /usr/local/freeswitch/db \' >> /docker-entrypoint.sh && \
    echo '    -storage /usr/local/freeswitch/storage \' >> /docker-entrypoint.sh && \
    echo '    -recordings /usr/local/freeswitch/recordings \' >> /docker-entrypoint.sh && \
    echo '    -run /usr/local/freeswitch/run \' >> /docker-entrypoint.sh && \
    echo '    -u freeswitch -g freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -nf -nc' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π healthcheck –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Event Socket –∏ SIP
HEALTHCHECK --interval=30s --timeout=10s --start-period=3m --retries=3 \
    CMD nc -z 127.0.0.1 8021 && \
        /usr/local/freeswitch/bin/fs_cli -x "status" | grep -q "UP" || exit 1

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/docker-entrypoint.sh"] 