# üîí –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–∑ FreeSWITCH
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º Debian (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
FROM debian:12-slim

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–∞
LABEL maintainer="Dailer Team"
LABEL description="Secure FreeSWITCH for Dailer Project"
LABEL version="1.10.12"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ FreeSWITCH
RUN apt-get update && apt-get install -y \
    # –ë–∞–∑–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
    build-essential \
    cmake \
    automake \
    autoconf \
    libtool \
    pkg-config \
    git \
    # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ FreeSWITCH
    libssl-dev \
    libcurl4-openssl-dev \
    libpcre3-dev \
    libspeex-dev \
    libspeexdsp-dev \
    libedit-dev \
    libtiff5-dev \
    yasm \
    # –ê—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ –∫–æ–¥–µ–∫–∏
    libavformat-dev \
    libswscale-dev \
    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
    libsqlite3-dev \
    # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    netcat-openbsd \
    telnet \
    net-tools \
    iputils-ping \
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º FreeSWITCH –∏–∑ –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–æ–¥–æ–≤ (–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨!)
RUN cd /usr/src && \
    git clone https://github.com/signalwire/freeswitch.git -b v1.10.12 && \
    cd freeswitch && \
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–±–æ—Ä–∫—É
    ./bootstrap.sh -j && \
    ./configure \
        --prefix=/usr/local/freeswitch \
        --sysconfdir=/etc/freeswitch \
        --enable-core-libedit-support \
        --disable-dependency-tracking \
        --enable-zrtp && \
    # –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º (–∑–∞–Ω–∏–º–∞–µ—Ç –≤—Ä–µ–º—è, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ç–æ–∏—Ç —Ç–æ–≥–æ!)
    make -j$(nproc) && \
    make install && \
    # –û—á–∏—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
    cd / && rm -rf /usr/src/freeswitch

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è freeswitch –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -r -s /bin/false freeswitch

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–±—Ä–∞–Ω–Ω–æ–≥–æ FreeSWITCH
RUN mkdir -p /usr/local/freeswitch/log \
             /usr/local/freeswitch/db \
             /usr/local/freeswitch/storage \
             /usr/local/freeswitch/recordings \
             /usr/local/freeswitch/run

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
RUN chown -R freeswitch:freeswitch /usr/local/freeswitch \
                                   /etc/freeswitch

# –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Event Socket
RUN echo '<?xml version="1.0" encoding="UTF-8"?>' > /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '<configuration name="event_socket.conf" description="Socket Client">' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  <settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="nat-map" value="false"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-ip" value="0.0.0.0"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-port" value="8021"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="password" value="ClueCon"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="apply-inbound-acl" value="loopback.auto"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="stop-on-bind-error" value="true"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  </settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml

# –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π modules.conf.xml –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –º–æ–¥—É–ª–µ–π
RUN echo '<?xml version="1.0" encoding="UTF-8"?>' > /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '<configuration name="modules.conf" description="Modules">' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '  <modules>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_event_socket"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_sofia"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_commands"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_console"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_dptools"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '    <load module="mod_dialplan_xml"/>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '  </modules>' >> /etc/freeswitch/autoload_configs/modules.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/modules.conf.xml

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
RUN chown -R freeswitch:freeswitch /etc/freeswitch

# –î–æ–±–∞–≤–ª—è–µ–º FreeSWITCH –≤ PATH
ENV PATH="/usr/local/freeswitch/bin:${PATH}"

# Expose —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã FreeSWITCH
EXPOSE 5060/udp 5080/udp 8021/tcp 16384-16394/udp

# –°–æ–∑–¥–∞–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
RUN echo '#!/bin/bash' > /docker-entrypoint.sh && \
    echo 'set -e' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏' >> /docker-entrypoint.sh && \
    echo 'sleep 5' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞' >> /docker-entrypoint.sh && \
    echo 'chown -R freeswitch:freeswitch /usr/local/freeswitch /etc/freeswitch' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ó–∞–ø—É—Å–∫–∞–µ–º FreeSWITCH –≤ foreground —Ä–µ–∂–∏–º–µ' >> /docker-entrypoint.sh && \
    echo 'exec /usr/local/freeswitch/bin/freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -conf /etc/freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -log /usr/local/freeswitch/log \' >> /docker-entrypoint.sh && \
    echo '    -db /usr/local/freeswitch/db \' >> /docker-entrypoint.sh && \
    echo '    -storage /usr/local/freeswitch/storage \' >> /docker-entrypoint.sh && \
    echo '    -recordings /usr/local/freeswitch/recordings \' >> /docker-entrypoint.sh && \
    echo '    -run /usr/local/freeswitch/run \' >> /docker-entrypoint.sh && \
    echo '    -u freeswitch -g freeswitch \' >> /docker-entrypoint.sh && \
    echo '    -nf -nc' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD /usr/local/freeswitch/bin/fs_cli -x "status" || exit 1

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/docker-entrypoint.sh"] 