# üîí –°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ–±—Ä–∞–∑ FreeSWITCH
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º Debian (–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
FROM debian:12-slim

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑–∞
LABEL maintainer="Dailer Team"
LABEL description="Secure FreeSWITCH for Dailer Project"
LABEL version="1.10.12"

# –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞–∫–µ—Ç—ã –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN apt-get update && apt-get install -y \
    # –û—Å–Ω–æ–≤–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    curl \
    wget \
    gnupg2 \
    apt-transport-https \
    ca-certificates \
    lsb-release \
    # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
    netcat-openbsd \
    telnet \
    net-tools \
    iputils-ping \
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# –î–æ–±–∞–≤–ª—è–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π FreeSWITCH
RUN curl -fSsL https://files.freeswitch.org/repo/deb/debian-release/fsstretch-archive-keyring.asc | \
    gpg --dearmor --output /usr/share/keyrings/freeswitch-archive-keyring.gpg

RUN echo "deb [signed-by=/usr/share/keyrings/freeswitch-archive-keyring.gpg] \
    https://files.freeswitch.org/repo/deb/debian-release/ bookworm main" > \
    /etc/apt/sources.list.d/freeswitch.list

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FreeSWITCH –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
RUN apt-get update && apt-get install -y \
    freeswitch \
    freeswitch-meta-all \
    freeswitch-mod-commands \
    freeswitch-mod-console \
    freeswitch-mod-logfile \
    freeswitch-mod-event-socket \
    freeswitch-mod-sofia \
    freeswitch-mod-dptools \
    freeswitch-mod-dialplan-xml \
    freeswitch-mod-spandsp \
    freeswitch-mod-g722 \
    freeswitch-mod-g729 \
    freeswitch-mod-amr \
    freeswitch-mod-ilbc \
    freeswitch-mod-speex \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è freeswitch –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
RUN useradd -r -s /bin/false freeswitch

# –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p /var/lib/freeswitch \
             /var/log/freeswitch \
             /var/run/freeswitch \
             /etc/freeswitch

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
RUN chown -R freeswitch:freeswitch /var/lib/freeswitch \
                                   /var/log/freeswitch \
                                   /var/run/freeswitch \
                                   /etc/freeswitch

# –ö–æ–ø–∏—Ä—É–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é FreeSWITCH
RUN cp -r /usr/share/freeswitch/conf/vanilla/* /etc/freeswitch/

# –°–æ–∑–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Event Socket
RUN echo '<?xml version="1.0" encoding="UTF-8"?>' > /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '<configuration name="event_socket.conf" description="Socket Client">' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  <settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="nat-map" value="false"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-ip" value="0.0.0.0"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="listen-port" value="8021"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="password" value="ClueCon"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="apply-inbound-acl" value="loopback.auto"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '    <param name="stop-on-bind-error" value="true"/>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '  </settings>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml && \
    echo '</configuration>' >> /etc/freeswitch/autoload_configs/event_socket.conf.xml

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
RUN chown -R freeswitch:freeswitch /etc/freeswitch

# Expose —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã FreeSWITCH
EXPOSE 5060/udp 5080/udp 8021/tcp 16384-16394/udp

# –°–æ–∑–¥–∞–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
RUN echo '#!/bin/bash' > /docker-entrypoint.sh && \
    echo 'set -e' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ñ–¥–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ç–∏' >> /docker-entrypoint.sh && \
    echo 'sleep 5' >> /docker-entrypoint.sh && \
    echo '' >> /docker-entrypoint.sh && \
    echo '# –ó–∞–ø—É—Å–∫–∞–µ–º FreeSWITCH –≤ foreground —Ä–µ–∂–∏–º–µ' >> /docker-entrypoint.sh && \
    echo 'exec /usr/bin/freeswitch -nc -nf -u freeswitch -g freeswitch' >> /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=60s --retries=3 \
    CMD fs_cli -x "status" || exit 1

# –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/docker-entrypoint.sh"] 