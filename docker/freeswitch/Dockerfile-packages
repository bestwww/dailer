# üê≥ FreeSWITCH Docker - –ì–û–¢–û–í–´–ï –ü–ê–ö–ï–¢–´ (–ë–´–°–¢–†–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê!)
# –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞–∫–µ—Ç—ã SignalWire –≤–º–µ—Å—Ç–æ —Å–±–æ—Ä–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
FROM ubuntu:22.04

# üìã –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="Dailer Team"
LABEL description="FreeSWITCH for Dailer - using official packages"
LABEL version="1.10.12-packages"

# üåç –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV FREESWITCH_VERSION=1.10

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && \
    apt-get install -y \
        # –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
        wget \
        gnupg2 \
        lsb-release \
        ca-certificates \
        # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        netcat-openbsd \
        telnet \
        net-tools \
        iputils-ping \
        # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
        curl \
        vim \
        htop && \
    echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# üîë –î–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π FreeSWITCH (–ê–ö–¢–£–ê–õ–¨–ù–´–ô –°–ü–û–°–û–ë 2025)
RUN echo "üîë –î–æ–±–∞–≤–ª—è–µ–º –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π FreeSWITCH (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥)..." && \
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–ø–æ—Å–æ–± —Å apt-key –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
    wget -O - https://files.freeswitch.org/repo/deb/debian-release/fsstretch-archive-keyring.asc | apt-key add - && \
    # HTTP –≤–º–µ—Å—Ç–æ HTTPS –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∫–∞–∫ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)
    echo "deb http://files.freeswitch.org/repo/deb/debian-release/ $(lsb_release -sc) main" > /etc/apt/sources.list.d/freeswitch.list && \
    echo "deb-src http://files.freeswitch.org/repo/deb/debian-release/ $(lsb_release -sc) main" >> /etc/apt/sources.list.d/freeswitch.list && \
    echo "‚úÖ –ü—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π FreeSWITCH –¥–æ–±–∞–≤–ª–µ–Ω (–∞–∫—Ç—É–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ 2025)"

# üì¶ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FreeSWITCH (–û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –°–ü–û–°–û–ë)
RUN echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º FreeSWITCH –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ (–ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)..." && \
    apt-get update && \
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç FreeSWITCH –∫–∞–∫ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
    apt-get install -y freeswitch-meta-all && \
    echo "‚úÖ FreeSWITCH —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –ø–æ–ª–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º –º–æ–¥—É–ª–µ–π (–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±)!"

# üóÇÔ∏è –°–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
RUN mkdir -p \
        /var/lib/freeswitch/storage \
        /var/lib/freeswitch/recordings \
        /var/log/freeswitch \
        /etc/freeswitch && \
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# üë§ –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è freeswitch –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
RUN if ! id "freeswitch" &>/dev/null; then \
        useradd --system --home-dir /var/lib/freeswitch --shell /bin/false freeswitch; \
    fi && \
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å freeswitch –Ω–∞—Å—Ç—Ä–æ–µ–Ω"

# üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
RUN chown -R freeswitch:freeswitch \
        /var/lib/freeswitch \
        /var/log/freeswitch \
        /etc/freeswitch \
        /usr/share/freeswitch && \
    echo "‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

# üßπ –û—á–∏—Å—Ç–∫–∞ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /tmp/* && \
    rm -rf /var/tmp/* && \
    echo "üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

# üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /etc/freeswitch

# üîå –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ—Ä—Ç—ã
EXPOSE 5060/udp 5060/tcp 5080/udp 5080/tcp
EXPOSE 16384-32768/udp
EXPOSE 8021/tcp

# üè• –î–æ–±–∞–≤–ª—è–µ–º healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD fs_cli -x "status" | grep -q "UP" || exit 1

# üìù –ö–æ–ø–∏—Ä—É–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["freeswitch", "-nonat", "-c"] 