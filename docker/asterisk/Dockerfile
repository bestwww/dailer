# üÜï Asterisk Docker –æ–±—Ä–∞–∑ –¥–ª—è Dailer
# –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ FreeSWITCH —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π AMI

FROM ubuntu:22.04

# üìã –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL maintainer="Dailer Team"
LABEL description="Asterisk for Dailer Project - AMI/ARI support"
LABEL version="20.x"

# üåç –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∞–∑–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && \
    apt-get install -y \
        # –ë–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
        wget \
        curl \
        gnupg2 \
        ca-certificates \
        software-properties-common \
        lsb-release \
        # –°–µ—Ç–µ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        netcat-openbsd \
        telnet \
        net-tools \
        iputils-ping \
        dnsutils \
        # –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã
        vim \
        nano \
        htop \
        tree \
        # –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è Asterisk
        build-essential \
        libxml2-dev \
        libncurses5-dev \
        uuid-dev \
        libjansson-dev \
        libsqlite3-dev \
        libssl-dev \
        # –ê—É–¥–∏–æ –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        libasound2-dev \
        libspeex-dev \
        libspeexdsp-dev \
        # Codec –ø–æ–¥–¥–µ—Ä–∂–∫–∞
        libopus-dev \
        libvorbis-dev \
        libmp3lame-dev && \
    echo "‚úÖ –ë–∞–∑–æ–≤—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# üéØ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Asterisk –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
RUN echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Asterisk..." && \
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π Asterisk
    wget -qO- http://deb.asterisk.org/asterisk-public.key | apt-key add - && \
    echo "deb http://deb.asterisk.org/asterisk-20-lts $(lsb_release -sc) main" > /etc/apt/sources.list.d/asterisk.list && \
    apt-get update && \
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Asterisk —Å –±–∞–∑–æ–≤—ã–º–∏ –º–æ–¥—É–ª—è–º–∏
    apt-get install -y \
        asterisk \
        asterisk-modules \
        asterisk-core-sounds-en \
        asterisk-core-sounds-ru && \
    echo "‚úÖ Asterisk —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# üóÇÔ∏è –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /usr/share/asterisk/sounds \
        /tmp/asterisk && \
    echo "‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å–æ–∑–¥–∞–Ω–∞"

# üë§ –°–æ–∑–¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è asterisk
RUN useradd --system --home-dir /var/lib/asterisk --shell /bin/false asterisk && \
    chown -R asterisk:asterisk \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /usr/share/asterisk && \
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å asterisk —Å–æ–∑–¥–∞–Ω"

# üîß –ö–æ–ø–∏—Ä—É–µ–º –±–∞–∑–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
COPY conf/ /etc/asterisk/
RUN chown -R asterisk:asterisk /etc/asterisk

# üßπ –û—á–∏—Å—Ç–∫–∞ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞
RUN apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /tmp/* && \
    rm -rf /var/tmp/* && \
    echo "üßπ –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"

# üìÇ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
WORKDIR /etc/asterisk

# üîå –û—Ç–∫—Ä—ã–≤–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–æ—Ä—Ç—ã
# SIP –ø–æ—Ä—Ç—ã
EXPOSE 5060/udp 5060/tcp
# RTP –ø–æ—Ä—Ç—ã
EXPOSE 10000-20000/udp
# AMI (Asterisk Manager Interface)
EXPOSE 5038/tcp
# ARI (Asterisk REST Interface)  
EXPOSE 8088/tcp

# üè• –î–æ–±–∞–≤–ª—è–µ–º healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD asterisk -rx "core show version" || exit 1

# üìù –ö–æ–ø–∏—Ä—É–µ–º entrypoint —Å–∫—Ä–∏–ø—Ç
COPY docker-entrypoint.sh /docker-entrypoint.sh
RUN chmod +x /docker-entrypoint.sh

# üöÄ –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["asterisk", "-f", "-vvv"] 