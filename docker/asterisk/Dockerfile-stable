# –°–¢–ê–ë–ò–õ–¨–ù–´–ô ASTERISK 20.15.0 LTS - Multi-stage build
FROM ubuntu:22.04 AS builder

# Build-time –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
ENV DEBIAN_FRONTEND=noninteractive
ENV ASTERISK_VERSION=20.15.0

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ build –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    build-essential \
    wget \
    autoconf \
    automake \
    libtool \
    pkg-config \
    libjansson-dev \
    libxml2-dev \
    libsqlite3-dev \
    libssl-dev \
    libedit-dev \
    libncurses5-dev \
    uuid-dev \
    libcap-dev \
    libcurl4-openssl-dev \
    libnewt-dev \
    libsrtp2-dev \
    libgsm1-dev \
    libspeex-dev \
    libspeexdsp-dev \
    zlib1g-dev \
    libffi-dev \
    && rm -rf /var/lib/apt/lists/*

# üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∫–æ–º–ø–∏–ª—è—Ü–∏—è –°–¢–ê–ë–ò–õ–¨–ù–û–ì–û Asterisk 20.15.0
WORKDIR /usr/src
RUN echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –°–¢–ê–ë–ò–õ–¨–ù–û–ì–û Asterisk 20.15.0..." && \
    wget -q https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-20-current.tar.gz && \
    tar -xzf asterisk-20-current.tar.gz && \
    rm asterisk-20-current.tar.gz && \
    cd asterisk-20* && \
    echo "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –°–¢–ê–ë–ò–õ–¨–ù–û–ô —Ä–∞–±–æ—Ç—ã..." && \
    ./configure \
        --with-jansson-bundled \
        --with-pjproject-bundled \
        --disable-xmldoc \
        --enable-permanent-dlopen \
        --without-asound \
        --without-oss \
        --without-gtk2 \
        --without-qt \
        --without-radius \
        --without-h323 \
        --without-unixodbc \
        --without-neon \
        --without-neon29 \
        --without-lua \
        --without-tds \
        --without-postgres \
        --without-mysql \
        --without-bfd \
        --without-ldap \
        --without-dahdi \
        --without-pri \
        --without-ss7 \
        --without-spandsp \
        --without-portaudio \
        --without-jack && \
    echo "üèóÔ∏è –ö–æ–º–ø–∏–ª—è—Ü–∏—è –°–¢–ê–ë–ò–õ–¨–ù–û–ô –≤–µ—Ä—Å–∏–∏..." && \
    make -j$(nproc) && \
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞..." && \
    make install && \
    make samples && \
    make config

# ==========================================
# PRODUCTION IMAGE - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä
# ==========================================
FROM ubuntu:22.04 AS production

ENV DEBIAN_FRONTEND=noninteractive
ENV ASTERISK_USER=asterisk
ENV ASTERISK_GROUP=asterisk

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ runtime –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
RUN apt-get update && apt-get install -y \
    # –¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ runtime –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    libjansson4 \
    libxml2 \
    libsqlite3-0 \
    libssl3 \
    libedit2 \
    libncurses6 \
    uuid-runtime \
    libcap2 \
    libcurl4 \
    libnewt0.52 \
    libsrtp2-1 \
    libgsm1 \
    libspeex1 \
    libspeexdsp1 \
    zlib1g \
    libffi8 \
    # –°–∏—Å—Ç–µ–º–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è asterisk
RUN groupadd -r $ASTERISK_GROUP && \
    useradd -r -g $ASTERISK_GROUP -d /var/lib/asterisk -s /bin/bash $ASTERISK_USER

# üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN mkdir -p \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /var/run/asterisk \
        /usr/share/asterisk && \
    chown -R $ASTERISK_USER:$ASTERISK_GROUP \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /var/run/asterisk \
        /usr/share/asterisk

# üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –°–¢–ê–ë–ò–õ–¨–ù–û–ì–û Asterisk –∏–∑ builder stage
COPY --from=builder /usr/sbin/asterisk /usr/sbin/asterisk
COPY --from=builder /usr/lib/asterisk /usr/lib/asterisk
COPY --from=builder /var/lib/asterisk /var/lib/asterisk
COPY --from=builder /etc/asterisk /etc/asterisk

# üìö –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ shared libraries (–ö–†–ò–¢–ò–ß–ù–û!)
RUN mkdir -p /usr/lib/x86_64-linux-gnu/
COPY --from=builder /usr/lib/libasterisk*.so* /usr/lib/
COPY --from=builder /usr/lib/x86_64-linux-gnu/ /usr/lib/x86_64-linux-gnu/

# üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
COPY conf-minimal/ /etc/asterisk/

# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
RUN chown -R $ASTERISK_USER:$ASTERISK_GROUP /etc/asterisk/ /var/lib/asterisk/ /var/log/asterisk/ /var/spool/asterisk/ /var/run/asterisk/

# üöÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è asterisk
USER $ASTERISK_USER
WORKDIR /var/lib/asterisk

# üì° –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤
EXPOSE 5060/udp 5060/tcp 5038/tcp 10000-20000/udp

# üé¨ Healthcheck
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD asterisk -r -x "core show version" || exit 1

# üéØ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["asterisk", "-f", "-c", "-vvv"] 