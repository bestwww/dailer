FROM ubuntu:22.04

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
LABEL description="Official Asterisk 22.5.0 LTS from source"
LABEL version="22.5.0"
LABEL maintainer="Dialer Project"

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
ENV DEBIAN_FRONTEND=noninteractive
ENV ASTERISK_VERSION=22.5.0
ENV ASTERISK_USER=asterisk
ENV ASTERISK_GROUP=asterisk

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Å–±–æ—Ä–∫–∏
RUN echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..." && \
    apt-get update && \
    apt-get install -y \
        # –û—Å–Ω–æ–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å–±–æ—Ä–∫–∏
        build-essential \
        wget \
        curl \
        git \
        autoconf \
        automake \
        libtool \
        pkg-config \
        # –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
        libjansson-dev \
        libxml2-dev \
        libsqlite3-dev \
        libssl-dev \
        libedit-dev \
        libedit2 \
        libncurses5-dev \
        # UUID –∏ –¥—Ä—É–≥–∏–µ —É—Ç–∏–ª–∏—Ç—ã
        uuid-dev \
        libcap-dev \
        libcurl4-openssl-dev \
        # PJSIP –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        libnewt-dev \
        libsrtp2-dev \
        # –ó–≤—É–∫–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        libgsm1-dev \
        libspeex-dev \
        libspeexdsp-dev \
        libogg-dev \
        libvorbis-dev \
        libresample1-dev \
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        zlib1g-dev \
        libffi-dev \
        # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞
        && apt-get clean \
        && rm -rf /var/lib/apt/lists/*

# üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è asterisk
RUN echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." && \
    groupadd -r $ASTERISK_GROUP && \
    useradd -r -g $ASTERISK_GROUP -d /var/lib/asterisk -s /bin/bash $ASTERISK_USER

# üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã—Ö –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤ Asterisk 22.5.0
WORKDIR /usr/src
RUN echo "üì• –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –û–§–ò–¶–ò–ê–õ–¨–ù–û–ì–û Asterisk 22.5.0..." && \
    wget -q https://downloads.asterisk.org/pub/telephony/asterisk/asterisk-22-current.tar.gz && \
    echo "üì¶ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞..." && \
    tar -xzf asterisk-22-current.tar.gz && \
    rm asterisk-22-current.tar.gz && \
    echo "üìÅ –ü–æ–∏—Å–∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ Asterisk..." && \
    ASTERISK_DIR=$(find /usr/src -maxdepth 1 -type d -name "asterisk-*" | head -1) && \
    echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $ASTERISK_DIR" && \
    ls -la $ASTERISK_DIR

# üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —Å–±–æ—Ä–∫–∞ (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é)
RUN echo "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Asterisk..." && \
    ASTERISK_DIR=$(find /usr/src -maxdepth 1 -type d -name "asterisk-*" | head -1) && \
    cd "$ASTERISK_DIR" && \
    echo "üìç –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)" && \
    echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:" && \
    ls -la | head -10 && \
    echo "üîß –ó–∞–ø—É—Å–∫ configure..." && \
    ./configure \
        --with-jansson-bundled \
        --with-pjproject-bundled \
        --disable-xmldoc \
        --without-asound \
        --without-oss \
        --without-gtk2 \
        --without-qt \
        --without-radius \
        --without-h323 \
        --without-unixodbc \
        --without-neon \
        --without-neon29 \
        --without-lua \
        --without-tds \
        --without-postgres \
        --without-mysql \
        --without-bfd \
        --without-ldap \
        --without-dahdi \
        --without-pri \
        --without-ss7 \
        --without-spandsp \
        --without-portaudio \
        --without-jack && \
    echo "üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# üèóÔ∏è –ö–æ–º–ø–∏–ª—è—Ü–∏—è (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è Docker)
RUN echo "üèóÔ∏è –ö–æ–º–ø–∏–ª—è—Ü–∏—è Asterisk (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ CPU)..." && \
    ASTERISK_DIR=$(find /usr/src -maxdepth 1 -type d -name "asterisk-*" | head -1) && \
    cd "$ASTERISK_DIR" && \
    make -j$(nproc) && \
    echo "‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞
RUN echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Asterisk..." && \
    ASTERISK_DIR=$(find /usr/src -maxdepth 1 -type d -name "asterisk-*" | head -1) && \
    cd "$ASTERISK_DIR" && \
    make install && \
    make samples && \
    make config && \
    echo "‚úÖ Asterisk —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# üóÇÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
RUN echo "üóÇÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..." && \
    mkdir -p \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /var/run/asterisk \
        /usr/share/asterisk && \
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
RUN echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤..." && \
    chown -R $ASTERISK_USER:$ASTERISK_GROUP \
        /etc/asterisk \
        /var/lib/asterisk \
        /var/log/asterisk \
        /var/spool/asterisk \
        /var/run/asterisk \
        /usr/share/asterisk && \
    echo "‚úÖ –ü—Ä–∞–≤–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

# üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
COPY conf/ /etc/asterisk/

# üîí –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
RUN chown -R $ASTERISK_USER:$ASTERISK_GROUP /etc/asterisk/

# üìù –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —Å–±–æ—Ä–∫–∏
RUN echo "üìù –û—á–∏—Å—Ç–∫–∞..." && \
    rm -rf /usr/src/asterisk-* && \
    apt-get purge -y \
        build-essential \
        wget \
        git \
        autoconf \
        automake \
        libtool \
        libjansson-dev \
        libxml2-dev \
        libsqlite3-dev \
        libssl-dev \
        libedit-dev \
        libncurses5-dev \
        uuid-dev \
        libcap-dev \
        libcurl4-openssl-dev && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# üöÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è asterisk
USER $ASTERISK_USER
WORKDIR /var/lib/asterisk

# üéØ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏
RUN asterisk -V

# üì° –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–æ–≤
EXPOSE 5060/udp 5060/tcp 5038/tcp 10000-20000/udp

# üé¨ –ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø—É—Å–∫–∞
CMD ["asterisk", "-f", "-c", "-vvv"] 