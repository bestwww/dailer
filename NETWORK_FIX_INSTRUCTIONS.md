# ðŸŒ Ð ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ SIP Ñ‚Ñ€Ð°Ð½ÐºÐ°

## ðŸ“‹ ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°
ÐŸÐ¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ FreeSWITCH Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ `external` Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½, Ð½Ð¾ gateway `sip_trunk` Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² ÑÑ‚Ð°Ñ‚ÑƒÑÐµ DOWN Ð¸Ð·-Ð·Ð° ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ SIP ÑÐµÑ€Ð²ÐµÑ€Ð° `62.141.121.197:5070` Ð¸Ð· ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° FreeSWITCH.

## âœ… Ð§Ñ‚Ð¾ ÑƒÐ¶Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾
- âœ… ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ 'external' Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ (RUNNING)
- âœ… Gateway 'sip_trunk' Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½
- âœ… Ð¡Ð¾Ñ„Ð¸Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°
- âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð° Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ

## âŒ Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°
```
DEBUG: State    NOREG
DEBUG: Status   DOWN
ERROR: âŒ Gateway Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
DEBUG: Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð·Ð²Ð¾Ð½ÐºÐ°: -ERR GATEWAY_DOWN
```

## ðŸš€ Ð Ð•Ð¨Ð•ÐÐ˜Ð•: Host Networking

### ÐÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð¼ ÑÐµÑ€Ð²ÐµÑ€Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ:

```bash
# 1. ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
cd ~/dailer

# 2. ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
git pull origin main

# 3. Ð‘Ð«Ð¡Ð¢Ð ÐžÐ• Ð Ð•Ð¨Ð•ÐÐ˜Ð•: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
./quick-fix-sip-network.sh

# 4. ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð²Ð¾Ð½Ð¾Ðº
./test-sip-trunk.sh call 79206054020
```

## ðŸ”§ Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ `quick-fix-sip-network.sh`:

1. **ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚** Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ FreeSWITCH
2. **Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚** `docker-compose.override.yml` Ñ host networking
3. **ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÑ‚** ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ Sofia Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð±ÐµÐ· NAT  
4. **Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚** FreeSWITCH Ñ Ð¿Ñ€ÑÐ¼Ñ‹Ð¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ðº ÑÐµÑ‚Ð¸ Ñ…Ð¾ÑÑ‚Ð°
5. **Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÑ‚** Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ SIP ÑÐµÑ€Ð²ÐµÑ€Ð°

## ðŸ“ ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ (Ñ€ÑƒÑ‡Ð½Ð¾Ð¹):

### Ð¨Ð°Ð³ 1: ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° FreeSWITCH
```bash
docker compose stop freeswitch
docker compose rm -f freeswitch
```

### Ð¨Ð°Ð³ 2: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ñ host networking
```bash
cat > docker-compose.override.yml << 'EOF'
version: '3.8'

services:
  freeswitch:
    network_mode: host
    ports: []
    environment:
      - FREESWITCH_IP_ADDRESS=0.0.0.0
      - FREESWITCH_SIP_PORT=5060
      - FREESWITCH_EVENT_SOCKET_PORT=8021
    command: freeswitch -nonat -nonatmap -u freeswitch -g freeswitch
EOF
```

### Ð¨Ð°Ð³ 3: Ð—Ð°Ð¿ÑƒÑÐº Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÐµÐ¹
```bash
docker compose up -d freeswitch
```

### Ð¨Ð°Ð³ 4: ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Sofia
```bash
# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° (30 ÑÐµÐºÑƒÐ½Ð´)
sleep 30

# ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
CONTAINER=$(docker ps --filter name=freeswitch --format "{{.Names}}" | head -1)
docker exec $CONTAINER fs_cli -x "reloadxml"
docker exec $CONTAINER fs_cli -x "sofia profile external restart"
```

## ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°:
```bash
./test-sip-trunk.sh status
```

### Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð²Ð¾Ð½Ð¾Ðº:
```bash
./test-sip-trunk.sh call 79206054020
```

### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¾Ð³Ð¾Ð²:
```bash
docker compose logs -f freeswitch
```

## ðŸ” Ð”Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ° (Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)

Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÑŽÑ‚ÑÑ, Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÑƒ:
```bash
./fix-network-connectivity.sh
```

Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚:
- ÐÐ½Ð°Ð»Ð¸Ð· Docker ÑÐµÑ‚ÐµÐ¹
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÑƒ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð° FreeSWITCH
- Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐµÑ‚ÐµÐ²Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
- ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÑƒ DNS Ð¸ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸
- ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ

## ðŸ“‹ Ð’Ð°Ð¶Ð½Ñ‹Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ

### ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ host networking:
- FreeSWITCH Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ ÑÐµÑ‚ÑŒ Ñ…Ð¾ÑÑ‚Ð° Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ
- SIP Ð¿Ð¾Ñ€Ñ‚ 5060 Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ
- Event Socket Ð¿Ð¾Ñ€Ñ‚ 8021 Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ
- ÐÐµÑ‚ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ð¹ Docker ÑÐµÑ‚Ð¸ Ð´Ð»Ñ Ð¸ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹

### Ð¤Ð°Ð¹Ð»Ñ‹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:
- `docker-compose.override.yml` - ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ host networking
- `freeswitch/conf/autoload_configs/sofia.conf.xml` - Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð´Ð»Ñ host networking

## ðŸ”„ Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ðº bridge ÑÐµÑ‚Ð¸ (Ð¿Ñ€Ð¸ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸)

Ð•ÑÐ»Ð¸ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒÑÑ Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Docker ÑÐµÑ‚Ð¸:
```bash
rm docker-compose.override.yml
docker compose restart freeswitch
```

## âœ… ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚

ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ€ÐµÑˆÐµÐ½Ð¸Ñ:
- Gateway `sip_trunk` Ð² ÑÑ‚Ð°Ñ‚ÑƒÑÐµ UP Ð¸Ð»Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ðµ
- Ð˜ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð·Ð²Ð¾Ð½ÐºÐ¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚ Ð±ÐµÐ· Ð¾ÑˆÐ¸Ð±ÐºÐ¸ GATEWAY_DOWN
- FreeSWITCH Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº SIP ÑÐµÑ€Ð²ÐµÑ€Ñƒ `62.141.121.197:5070`

## ðŸ†˜ ÐŸÑ€Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ…

1. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸: `docker compose logs freeswitch`
2. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ñ€Ñ‚ 5060 ÑÐ²Ð¾Ð±Ð¾Ð´ÐµÐ½ Ð½Ð° Ñ…Ð¾ÑÑ‚Ðµ: `netstat -tulpn | grep 5060`
3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ SIP ÑÐµÑ€Ð²ÐµÑ€Ð° Ñ Ñ…Ð¾ÑÑ‚Ð°: `ping 62.141.121.197`
4. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ð·Ð° Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð¾Ð¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ `./fix-network-connectivity.sh` 