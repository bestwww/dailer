#!/bin/bash

# üìû –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤ —Å–∏—Å—Ç–µ–º—ã –∞–≤—Ç–æ–¥–æ–∑–≤–æ–Ω–∞
# –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∫–∞–∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–æ–º–µ—Ä–∞, —Ç–∞–∫ –∏ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–≤–æ–Ω–∫–∏

set -e

echo "üìû === –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ê–í–¢–û–î–û–ó–í–û–ù–ê ==="
echo

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [TEST] $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ FreeSWITCH
check_freeswitch() {
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å FreeSWITCH..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
    if ! docker ps | grep -q freeswitch; then
        log "‚ùå FreeSWITCH –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
        log "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º FreeSWITCH..."
        docker compose up -d freeswitch
        sleep 10
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Event Socket
    if docker exec $(docker ps | grep freeswitch | awk '{print $1}') nc -z 127.0.0.1 8021; then
        log "‚úÖ Event Socket –¥–æ—Å—Ç—É–ø–µ–Ω (–ø–æ—Ä—Ç 8021)"
    else
        log "‚ùå Event Socket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!"
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å FreeSWITCH
    log "üìä –°—Ç–∞—Ç—É—Å FreeSWITCH:"
    docker exec $(docker ps | grep freeswitch | awk '{print $1}') fs_cli -x "status" || true
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∑–≤–æ–Ω–∫–∞
test_call() {
    local number=$1
    local description=$2
    
    log "üìû –¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ $number ($description)"
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ FreeSWITCH
    local container_id=$(docker ps | grep freeswitch | awk '{print $1}')
    
    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è originate
    local cmd="originate user/$number &echo"
    
    log "üîß –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É: $cmd"
    
    # –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    if timeout 30 docker exec $container_id fs_cli -x "$cmd"; then
        log "‚úÖ –ó–≤–æ–Ω–æ–∫ –Ω–∞ $number –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ"
    else
        log "‚ùå –ó–≤–æ–Ω–æ–∫ –Ω–∞ $number –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –æ—à–∏–±–∫–æ–π"
    fi
    
    echo "----------------------------------------"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞
test_real_call() {
    local number=$1
    
    log "üìû –†–ï–ê–õ–¨–ù–´–ô –∑–≤–æ–Ω–æ–∫ –Ω–∞ –Ω–æ–º–µ—Ä $number"
    log "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –±—É–¥–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ —á–µ—Ä–µ–∑ SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞!"
    
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/N): " confirm
    
    if [[ $confirm != [yY] ]]; then
        log "‚èπÔ∏è  –†–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –æ—Ç–º–µ–Ω–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        return
    fi
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫
    local container_id=$(docker ps | grep freeswitch | awk '{print $1}')
    
    # –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è originate —Å —Ä–µ–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º
    local cmd="originate sofia/gateway/sip_trunk/$number &echo"
    
    log "üîß –í—ã–ø–æ–ª–Ω—è–µ–º –†–ï–ê–õ–¨–ù–´–ô –∑–≤–æ–Ω–æ–∫: $cmd"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    log "üì± –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –∑–≤–æ–Ω–∫–∞..."
    timeout 60 docker logs -f $container_id &
    local logs_pid=$!
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫
    if timeout 30 docker exec $container_id fs_cli -x "$cmd"; then
        log "‚úÖ –†–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ $number –≤—ã–ø–æ–ª–Ω–µ–Ω"
    else
        log "‚ùå –†–µ–∞–ª—å–Ω—ã–π –∑–≤–æ–Ω–æ–∫ –Ω–∞ $number –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –æ—à–∏–±–∫–æ–π"
    fi
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ª–æ–≥–æ–≤
    kill $logs_pid 2>/dev/null || true
    
    echo "----------------------------------------"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤ FreeSWITCH
show_logs() {
    log "üìã –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ FreeSWITCH..."
    local container_id=$(docker ps | grep freeswitch | awk '{print $1}')
    
    echo
    echo "=== –ü–û–°–õ–ï–î–ù–ò–ï 20 –°–¢–†–û–ö –õ–û–ì–û–í ==="
    docker logs --tail 20 $container_id
    
    echo
    echo "=== –ú–û–ù–ò–¢–û–†–ò–ù–ì –õ–û–ì–û–í –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò ==="
    echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    docker logs -f $container_id
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ SIP-—Ç—Ä–∞–Ω–∫–∞
check_sip_trunk() {
    log "üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ SIP-—Ç—Ä–∞–Ω–∫–∞..."
    local container_id=$(docker ps | grep freeswitch | awk '{print $1}')
    
    log "üìä –°—Ç–∞—Ç—É—Å Sofia –ø—Ä–æ—Ñ–∏–ª–µ–π:"
    docker exec $container_id fs_cli -x "sofia status"
    
    echo
    log "üåê –°–æ—Å—Ç–æ—è–Ω–∏–µ gateway:"
    docker exec $container_id fs_cli -x "sofia status gateway sip_trunk"
}

# –û—Å–Ω–æ–≤–Ω–æ–µ –º–µ–Ω—é
show_menu() {
    echo
    echo "üìû === –ú–ï–ù–Æ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø –ó–í–û–ù–ö–û–í ==="
    echo
    echo "–ë–ï–ó–û–ü–ê–°–ù–û–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –Ω–æ–º–µ—Ä–∞):"
    echo "  1) –¢–µ—Å—Ç 1204 - –∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ–ª–æ–≤–µ–∫–∞ (–∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω)"
    echo "  2) –¢–µ—Å—Ç 1205 - –∏–º–∏—Ç–∞—Ü–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"  
    echo "  3) –¢–µ—Å—Ç 1206 - –∏–º–∏—Ç–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞"
    echo
    echo "–†–ï–ê–õ–¨–ù–´–ï –ó–í–û–ù–ö–ò (—á–µ—Ä–µ–∑ SIP-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞):"
    echo "  4) –ó–≤–æ–Ω–æ–∫ –Ω–∞ 79206054020 (–≤–∞—à –Ω–æ–º–µ—Ä)"
    echo "  5) –ó–≤–æ–Ω–æ–∫ –Ω–∞ –¥—Ä—É–≥–æ–π –Ω–æ–º–µ—Ä (–≤–≤–µ—Å—Ç–∏ –≤—Ä—É—á–Ω—É—é)"
    echo
    echo "–î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:"
    echo "  6) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å FreeSWITCH"
    echo "  7) –ü—Ä–æ–≤–µ—Ä–∏—Ç—å SIP-—Ç—Ä–∞–Ω–∫"
    echo "  8) –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏ FreeSWITCH"
    echo "  9) –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª example_1.mp3"
    echo
    echo "  0) –í—ã—Ö–æ–¥"
    echo
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞
test_audio_file() {
    log "üéµ –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞—É–¥–∏–æ—Ñ–∞–π–ª example_1.mp3..."
    
    local container_id=$(docker ps | grep freeswitch | awk '{print $1}')
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ..."
    
    if docker exec $container_id test -f /usr/local/freeswitch/sounds/custom/example_1.mp3; then
        log "‚úÖ –§–∞–π–ª example_1.mp3 –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
        
        # –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
        log "‚ñ∂Ô∏è  –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞..."
        local cmd="originate loopback/1204 &playback(/usr/local/freeswitch/sounds/custom/example_1.mp3)"
        
        if docker exec $container_id fs_cli -x "$cmd"; then
            log "‚úÖ –ê—É–¥–∏–æ—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω"
        else
            log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞"
        fi
    else
        log "‚ùå –§–∞–π–ª example_1.mp3 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
        log "üìÅ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ /usr/local/freeswitch/sounds/:"
        docker exec $container_id find /usr/local/freeswitch/sounds -name "*.mp3" -o -name "*.wav" | head -10
    fi
}

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
main() {
    log "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–≤–æ–Ω–∫–æ–≤..."
    
    # –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    check_freeswitch
    
    while true; do
        show_menu
        read -p "–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø—Ü–∏—é (0-9): " choice
        
        case $choice in
            1)
                test_call "1204" "–∏–º–∏—Ç–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–∞ —á–µ–ª–æ–≤–µ–∫–∞"
                ;;
            2)
                test_call "1205" "–∏–º–∏—Ç–∞—Ü–∏—è –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç—á–∏–∫–∞"
                ;;
            3)
                test_call "1206" "–∏–º–∏—Ç–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞"
                ;;
            4)
                test_real_call "79206054020"
                ;;
            5)
                read -p "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (—Ñ–æ—Ä–º–∞—Ç 79XXXXXXXXX): " custom_number
                if [[ $custom_number =~ ^[78][0-9]{10}$ ]]; then
                    test_real_call "$custom_number"
                else
                    log "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞! –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 79XXXXXXXXX"
                fi
                ;;
            6)
                check_freeswitch
                ;;
            7)
                check_sip_trunk
                ;;
            8)
                show_logs
                ;;
            9)
                test_audio_file
                ;;
            0)
                log "üëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
                exit 0
                ;;
            *)
                log "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
                ;;
        esac
        
        echo
        read -p "–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è..."
    done
}

# –ó–∞–ø—É—Å–∫
main "$@" 