<?xml version="1.0" encoding="UTF-8"?>
<!-- 
  Конфигурация Sofia SIP стека
  Настроена для исходящих звонков системы автодозвона
-->
<configuration name="sofia.conf" description="Sofia Endpoint">

  <global_settings>
    <!-- Уровень логирования SIP -->
    <param name="log-level" value="0"/>
    <!-- Автоматическое перезапуск профилей -->
    <param name="auto-restart" value="false"/>
    <!-- Режим отладки -->
    <param name="debug-presence" value="0"/>
    <!-- Capture сервер для мониторинга SIP трафика -->
    <param name="capture-server" value="udp:homer.local:9060"/>
  </global_settings>

  <!-- Профили Sofia -->
  <profiles>
    
    <!-- Внешний профиль для исходящих звонков -->
    <profile name="external">
      <aliases>
        <alias name="outbound"/>
      </aliases>
      
      <gateways>
        <!-- 
          Конфигурация SIP транка 62.141.121.197:5070
          Peer-to-peer подключение без аутентификации
        -->
        <gateway name="sip_trunk">
          <!-- Основные настройки подключения -->
          <param name="proxy" value="62.141.121.197:5070"/>
          <param name="realm" value="62.141.121.197"/>
          <param name="register" value="false"/>
          <param name="register-transport" value="udp"/>
          
          <!-- Без аутентификации (peer-to-peer) -->
          <param name="username" value=""/>
          <param name="password" value=""/>
          <param name="from-user" value="freeswitch"/>
          <param name="from-domain" value="62.141.121.197"/>
          
          <!-- Настройки соединения -->
          <param name="retry-seconds" value="30"/>
          <param name="caller-id-in-from" value="true"/>
          <param name="contact-params" value=""/>
          <param name="ping" value="25"/>
          <param name="extension-in-contact" value="true"/>
          
          <!-- Настройки для исходящих звонков -->
          <param name="context" value="public"/>
          <param name="rtp-ip" value="auto"/>
          <param name="sip-ip" value="auto"/>
          
          <!-- Codec preferences -->
          <param name="codec-prefs" value="PCMU,PCMA,GSM"/>
          
          <!-- Дополнительные параметры -->
          <param name="extension" value=""/>
          <param name="expire-seconds" value="600"/>
        </gateway>
      </gateways>
      
      <settings>
        <!-- Основные настройки профиля -->
        <param name="context" value="public"/>
        <param name="rfc2833-pt" value="101"/>
        <param name="sip-port" value="$${external_sip_port}"/>
        <param name="dialplan" value="XML"/>
        
        <!-- Настройки медиа -->
        <param name="rtp-ip" value="$${local_ip_v4}"/>
        <param name="sip-ip" value="$${local_ip_v4}"/>
        <param name="ext-rtp-ip" value="$${external_rtp_ip}"/>
        <param name="ext-sip-ip" value="$${external_ip_v4}"/>
        
        <!-- RTP настройки -->
        <param name="rtp-timeout-sec" value="300"/>
        <param name="rtp-hold-timeout-sec" value="1800"/>
        
        <!-- Codec настройки -->
        <param name="inbound-codec-prefs" value="$${global_codec_prefs}"/>
        <param name="outbound-codec-prefs" value="$${outbound_codec_prefs}"/>
        
        <!-- Настройки аутентификации -->
        <param name="auth-calls" value="false"/>
        <param name="auth-all-packets" value="false"/>
        
        <!-- DTMF настройки -->
        <param name="dtmf-duration" value="2000"/>
        <param name="dtmf-type" value="rfc2833"/>
        
        <!-- Session таймауты -->
        <param name="session-timeout" value="1800"/>
        <param name="min-session-expires" value="120"/>
        
        <!-- Caller ID -->
        <param name="caller-id-type" value="rpid"/>
        
        <!-- Настройки для NAT -->
        <param name="aggressive-nat-detection" value="true"/>
        <param name="NDLB-received-in-nat-reg-contact" value="true"/>
        <param name="NDLB-force-rport" value="true"/>
        <param name="NDLB-broken-auth-hash" value="true"/>
        
        <!-- Настройки для автодозвона -->
        <param name="max-proceeding" value="1000"/>
        <param name="challenge-realm" value="auto_from"/>
        
      </settings>
    </profile>

    <!-- Внутренний профиль -->
    <profile name="internal">
      <aliases>
        <alias name="default"/>
      </aliases>
      
      <settings>
        <param name="context" value="default"/>
        <param name="rfc2833-pt" value="101"/>
        <param name="sip-port" value="$${internal_sip_port}"/>
        <param name="dialplan" value="XML"/>
        
        <!-- Медиа настройки -->
        <param name="rtp-ip" value="$${local_ip_v4}"/>
        <param name="sip-ip" value="$${local_ip_v4}"/>
        
        <!-- Codec настройки -->
        <param name="inbound-codec-prefs" value="$${global_codec_prefs}"/>
        <param name="outbound-codec-prefs" value="$${outbound_codec_prefs}"/>
        
        <!-- Аутентификация -->
        <param name="auth-calls" value="$${internal_auth_calls}"/>
        
        <!-- DTMF -->
        <param name="dtmf-duration" value="2000"/>
        <param name="dtmf-type" value="rfc2833"/>
        
        <!-- Hold music -->
        <param name="hold-music" value="$${hold_music}"/>
        
      </settings>
    </profile>

  </profiles>
</configuration> 